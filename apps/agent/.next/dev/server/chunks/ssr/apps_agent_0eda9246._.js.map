{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///workspaces/nexus-platform/apps/agent/src/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\";\n\n/**\n * üõ°Ô∏è SECURE PRISMA CLIENT CONFIGURATION\n * \n * Database: Supabase PostgreSQL (Transaction Pooler)\n * Connection: Uses environment variables for security\n * Mode: Transaction pooling (pgbouncer=true required)\n */\n\nconst globalForPrisma = global as unknown as { prisma: PrismaClient | undefined };\n\nfunction getPrismaClient() {\n  if (globalForPrisma.prisma) {\n    return globalForPrisma.prisma;\n  }\n\n  // Build time: return a dummy client that will fail at runtime if used\n  if (!process.env.DATABASE_URL) {\n    // During build, create a minimal client that won't actually connect\n    const client = new PrismaClient({\n      log: [],\n    });\n    \n    if (process.env.NODE_ENV !== \"production\") {\n      globalForPrisma.prisma = client;\n    }\n    \n    return client;\n  }\n\n  // Runtime: create properly configured client\n  const baseUrl = process.env.DATABASE_URL;\n  const connectionUrl = baseUrl.includes(\"?\")\n    ? `${baseUrl}&pgbouncer=true&connection_limit=1`\n    : `${baseUrl}?pgbouncer=true&connection_limit=1`;\n\n  const client = new PrismaClient({\n    datasources: {\n      db: {\n        url: connectionUrl,\n      },\n    },\n    log: process.env.NODE_ENV === \"development\" ? [\"error\", \"warn\"] : [\"error\"],\n  });\n\n  if (process.env.NODE_ENV !== \"production\") {\n    globalForPrisma.prisma = client;\n  }\n\n  return client;\n}\n\nexport const prisma = getPrismaClient();"],"names":[],"mappings":";;;;AAAA;;AAEA;;;;;;CAMC,GAED,MAAM;AAEN,SAAS;IACP,IAAI,gBAAgB,MAAM,EAAE;QAC1B,OAAO,gBAAgB,MAAM;IAC/B;IAEA,sEAAsE;IACtE,IAAI,CAAC,QAAQ,GAAG,CAAC,YAAY,EAAE;QAC7B,oEAAoE;QACpE,MAAM,SAAS,IAAI,sMAAY,CAAC;YAC9B,KAAK,EAAE;QACT;QAEA,wCAA2C;YACzC,gBAAgB,MAAM,GAAG;QAC3B;QAEA,OAAO;IACT;IAEA,6CAA6C;IAC7C,MAAM,UAAU,QAAQ,GAAG,CAAC,YAAY;IACxC,MAAM,gBAAgB,QAAQ,QAAQ,CAAC,OACnC,GAAG,QAAQ,kCAAkC,CAAC,GAC9C,GAAG,QAAQ,kCAAkC,CAAC;IAElD,MAAM,SAAS,IAAI,sMAAY,CAAC;QAC9B,aAAa;YACX,IAAI;gBACF,KAAK;YACP;QACF;QACA,KAAK,uCAAyC;YAAC;YAAS;SAAO,GAAG;IACpE;IAEA,wCAA2C;QACzC,gBAAgB,MAAM,GAAG;IAC3B;IAEA,OAAO;AACT;AAEO,MAAM,SAAS"}},
    {"offset": {"line": 56, "column": 0}, "map": {"version":3,"sources":["file:///workspaces/nexus-platform/apps/agent/src/lib/actions/transaction.ts"],"sourcesContent":["\"use server\";\n\nimport { prisma } from \"@/lib/prisma\";\nimport { revalidatePath } from \"next/cache\";\n\nexport type SaleItemInput = {\n    productId: string;\n    quantity: number;\n    price: number;\n};\n\nexport type TransactionResult =\n    | { success: true; saleId: string }\n    | { success: false; error: string };\n\nexport async function processTransaction(\n    userId: string,\n    shopId: string,\n    totalAmount: number,\n    items: SaleItemInput[],\n    paymentMethod: string = \"CASH\"\n): Promise<TransactionResult> {\n    console.log(\"üí≥ SERVER_ACTION: Initiating Sale for User:\", userId);\n    console.log(\"üè™ Shop ID:\", shopId);\n    console.log(\"üí∞ Total Amount:\", totalAmount);\n    console.log(\"üì¶ Items Count:\", items.length);\n\n    try {\n        // 1. Validation\n        if (!userId || !shopId || items.length === 0) {\n            console.error(\"‚ùå VALIDATION FAILED:\", { userId, shopId, itemsCount: items.length });\n            return { success: false, error: \"Invalid Data: Missing User, Shop, or Items\" };\n        }\n\n        if (totalAmount <= 0) {\n            console.error(\"‚ùå INVALID AMOUNT:\", totalAmount);\n            return { success: false, error: \"Invalid transaction amount\" };\n        }\n\n        // 2. Transaction\n        const sale = await prisma.$transaction(async (tx) => {\n            const saleLines = [];\n\n            // üöÄ OPTIMIZED: Batch fetch all products (eliminates N+1 query problem)\n            const productIds = items.map(item => item.productId);\n            const products = await tx.product.findMany({\n                where: { id: { in: productIds } },\n                select: { id: true, name: true, stockLevel: true }\n            });\n\n            // Create product map for O(1) lookup\n            const productMap = new Map(products.map(p => [p.id, p]));\n\n            // Validate all items first\n            for (const item of items) {\n                const product = productMap.get(item.productId);\n\n                if (!product) {\n                    console.error(`‚ùå Product Not Found: ${item.productId}`);\n                    throw new Error(`Product Not Found: ${item.productId}`);\n                }\n\n                if (product.stockLevel < item.quantity) {\n                    console.error(`‚ùå Insufficient Stock: ${product.name} (Need: ${item.quantity}, Have: ${product.stockLevel})`);\n                    throw new Error(`Out of Stock: ${product.name} (Need: ${item.quantity}, Available: ${product.stockLevel})`);\n                }\n\n                console.log(`‚úÖ Stock Check Passed: ${product.name} (Deducting: ${item.quantity})`);\n\n                saleLines.push({\n                    productId: item.productId,\n                    quantity: item.quantity,\n                    price: item.price\n                });\n            }\n\n            // üöÄ OPTIMIZED: Batch update all products in parallel\n            await Promise.all(\n                items.map(item =>\n                    tx.product.update({\n                        where: { id: item.productId },\n                        data: { stockLevel: { decrement: item.quantity } }\n                    })\n                )\n            );\n\n            // D. Create Sale Record\n            const createdSale = await tx.sale.create({\n                data: {\n                    userId,\n                    shopId,\n                    totalAmount,\n                    paymentMethod,\n                    status: \"COMPLETED\",\n                    items: {\n                        create: saleLines\n                    }\n                }\n            });\n\n            console.log(\"‚úÖ DATABASE: Sale record created:\", createdSale.id);\n            return createdSale;\n        });\n\n        console.log(\"‚úÖ SERVER_ACTION: Sale Completed:\", sale.id);\n\n        // 3. Revalidate Paths (Dashboard/History)\n        revalidatePath(\"/dashboard\");\n        revalidatePath(\"/mobilepos/history\");\n        revalidatePath(\"/mobilepos\");\n\n        return { success: true, saleId: sale.id };\n\n    } catch (error: any) {\n        console.error(\"‚ùå SERVER_ACTION_ERROR:\", error.message);\n        console.error(\"Stack:\", error.stack);\n        return { success: false, error: error.message || \"Transaction Failed\" };\n    }\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 186, "column": 0}, "map": {"version":3,"sources":["file:///workspaces/nexus-platform/apps/agent/.next-internal/server/app/mobilepos/pos/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["export {processTransaction as '7cc3ec16eba3023776a0853c7f2f780d37ac8f14b7'} from 'ACTIONS_MODULE0'\n"],"names":[],"mappings":";AAAA"}}]
}