{"version":3,"sources":["../../../../../apps/agent/src/lib/prisma.ts","../../../../../node_modules/.pnpm/next-auth%404.24.13_next%4016.1.6_react-dom%4019.2.4_react%4019.2.4__react%4019.2.4__react-dom%4019.2.4_react%4019.2.4__react%4019.2.4/node_modules/next-auth/core/types.js","../../../../../node_modules/.pnpm/next-auth%404.24.13_next%4016.1.6_react-dom%4019.2.4_react%4019.2.4__react%4019.2.4__react-dom%4019.2.4_react%4019.2.4__react%4019.2.4/node_modules/next-auth/index.js","../../../../../apps/agent/src/lib/activity-logger.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\";\n\n/**\n * üõ°Ô∏è SECURE PRISMA CLIENT CONFIGURATION\n * \n * Database: Supabase PostgreSQL (Transaction Pooler)\n * Connection: Uses environment variables for security\n * Mode: Transaction pooling (pgbouncer=true required)\n */\n\nconst globalForPrisma = global as unknown as { prisma: PrismaClient | undefined };\n\nfunction getPrismaClient() {\n  if (globalForPrisma.prisma) {\n    return globalForPrisma.prisma;\n  }\n\n  // Build time: return a dummy client that will fail at runtime if used\n  if (!process.env.DATABASE_URL) {\n    // During build, create a minimal client that won't actually connect\n    const client = new PrismaClient({\n      log: [],\n    });\n    \n    if (process.env.NODE_ENV !== \"production\") {\n      globalForPrisma.prisma = client;\n    }\n    \n    return client;\n  }\n\n  // Runtime: create properly configured client\n  const baseUrl = process.env.DATABASE_URL;\n  const connectionUrl = baseUrl.includes(\"?\")\n    ? `${baseUrl}&pgbouncer=true&connection_limit=1`\n    : `${baseUrl}?pgbouncer=true&connection_limit=1`;\n\n  const client = new PrismaClient({\n    datasources: {\n      db: {\n        url: connectionUrl,\n      },\n    },\n    log: process.env.NODE_ENV === \"development\" ? [\"error\", \"warn\"] : [\"error\"],\n  });\n\n  if (process.env.NODE_ENV !== \"production\") {\n    globalForPrisma.prisma = client;\n  }\n\n  return client;\n}\n\nexport const prisma = getPrismaClient();","\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});","\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nvar _exportNames = {};\nObject.defineProperty(exports, \"default\", {\n  enumerable: true,\n  get: function () {\n    return _next.default;\n  }\n});\nvar _types = require(\"./core/types\");\nObject.keys(_types).forEach(function (key) {\n  if (key === \"default\" || key === \"__esModule\") return;\n  if (Object.prototype.hasOwnProperty.call(_exportNames, key)) return;\n  if (key in exports && exports[key] === _types[key]) return;\n  Object.defineProperty(exports, key, {\n    enumerable: true,\n    get: function () {\n      return _types[key];\n    }\n  });\n});\nvar _next = _interopRequireWildcard(require(\"./next\"));\nObject.keys(_next).forEach(function (key) {\n  if (key === \"default\" || key === \"__esModule\") return;\n  if (Object.prototype.hasOwnProperty.call(_exportNames, key)) return;\n  if (key in exports && exports[key] === _next[key]) return;\n  Object.defineProperty(exports, key, {\n    enumerable: true,\n    get: function () {\n      return _next[key];\n    }\n  });\n});\nfunction _getRequireWildcardCache(e) { if (\"function\" != typeof WeakMap) return null; var r = new WeakMap(), t = new WeakMap(); return (_getRequireWildcardCache = function (e) { return e ? t : r; })(e); }\nfunction _interopRequireWildcard(e, r) { if (!r && e && e.__esModule) return e; if (null === e || \"object\" != typeof e && \"function\" != typeof e) return { default: e }; var t = _getRequireWildcardCache(r); if (t && t.has(e)) return t.get(e); var n = { __proto__: null }, a = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var u in e) if (\"default\" !== u && {}.hasOwnProperty.call(e, u)) { var i = a ? Object.getOwnPropertyDescriptor(e, u) : null; i && (i.get || i.set) ? Object.defineProperty(n, u, i) : n[u] = e[u]; } return n.default = e, t && t.set(e, n), n; }","import { prisma } from \"./prisma\";\n\nexport interface ActivityLogParams {\n  userId: string;\n  userName: string;\n  userRole: string;\n  action: string;\n  entity: string;\n  entityId?: string;\n  description: string;\n  metadata?: any;\n  ipAddress?: string;\n  userAgent?: string;\n  shopId?: string;\n  shopName?: string;\n}\n\n/**\n * Master Activity Logger - Logs all system activities\n * This captures every meaningful action from agents, admins, and all users\n */\nexport async function logActivity(params: ActivityLogParams) {\n  try {\n    await prisma.activityLog.create({\n      data: {\n        userId: params.userId,\n        userName: params.userName,\n        userRole: params.userRole,\n        action: params.action,\n        entity: params.entity,\n        entityId: params.entityId,\n        description: params.description,\n        metadata: params.metadata || {},\n        ipAddress: params.ipAddress,\n        userAgent: params.userAgent,\n        shopId: params.shopId,\n        shopName: params.shopName,\n      },\n    });\n  } catch (error) {\n    console.error(\"‚ùå Activity Logger Error:\", error);\n    // Don't throw - logging failures shouldn't break the main operation\n  }\n}\n\n/**\n * Log target-related activities with history tracking\n */\nexport async function logTargetActivity(\n  targetId: string,\n  userId: string,\n  action: \"CREATED\" | \"UPDATED\" | \"DELETED\" | \"PROGRESS_UPDATE\",\n  previousValue?: any,\n  newValue?: any,\n  progress?: number,\n  achievedValue?: number,\n  achievedQuantity?: number,\n  notes?: string\n) {\n  try {\n    await prisma.targetHistory.create({\n      data: {\n        targetId,\n        userId,\n        action,\n        previousValue: previousValue || {},\n        newValue: newValue || {},\n        progress: progress || 0,\n        achievedValue: achievedValue || 0,\n        achievedQuantity: achievedQuantity || 0,\n        notes,\n      },\n    });\n  } catch (error) {\n    console.error(\"‚ùå Target History Logger Error:\", error);\n  }\n}\n\n/**\n * Helper to get client IP from request headers\n */\nexport function getClientIp(request: Request): string | undefined {\n  const forwarded = request.headers.get(\"x-forwarded-for\");\n  const realIp = request.headers.get(\"x-real-ip\");\n  \n  if (forwarded) {\n    return forwarded.split(\",\")[0].trim();\n  }\n  \n  return realIp || undefined;\n}\n\n/**\n * Helper to get user agent from request headers\n */\nexport function getUserAgent(request: Request): string | undefined {\n  return request.headers.get(\"user-agent\") || undefined;\n}\n"],"names":[],"mappings":"68CAAA,IAAA,EAAA,EAAA,CAAA,CAAA,OAUA,IAAM,EAAA,EAAA,CAAA,CA2CO,EAzCb,AAyCsB,SAzCb,EACP,GAAI,EAAgB,MAAM,CACxB,CAD0B,MACnB,EAAgB,MAAM,CAI/B,GAAI,CAAC,QAAQ,GAAG,CAAC,YAAY,CAU3B,CAV6B,MAUtB,AARQ,IAAI,EAAA,YAAY,CAAC,CAC9B,IAAK,EAAE,AACT,GAUF,IAAM,EAAU,QAAQ,GAAG,CAAC,YAAY,CAClC,EAAgB,EAAQ,QAAQ,CAAC,KACnC,CAAA,EAAG,EAAQ,kCAAkC,CAAC,CAC9C,CAAA,EAAG,EAAQ,kCAAkC,CAAC,CAelD,OAbe,AAaR,IAbY,EAAA,YAAY,CAAC,CAC9B,YAAa,CACX,GAAI,CACF,IAAK,CACP,CACF,EACA,IAAkE,CAAC,AAA9D,QAAsE,AAC7E,EAOF,4BARkD,yFCzClD,OAAO,cAAc,CAAC,EAAS,aAAc,CAC3C,MAAO,EACT,iCCFA,OAAO,cAAc,CAAC,EAAS,aAAc,CAC3C,OAAO,CACT,GACA,IAAI,EAAe,CAAC,EACpB,OAAO,cAAc,CAAC,EAAS,UAAW,CACxC,YAAY,EACZ,IAAK,WACH,OAAO,EAAM,OAAO,AACtB,CACF,GACA,IAAI,EAAA,EAAA,CAAA,CAAA,OACJ,OAAO,IAAI,CAAC,GAAQ,OAAO,CAAC,SAAU,CAAG,EACvC,AAAY,YAAR,GAA6B,cAAc,CAAtB,GACrB,OAAO,SAAS,CAAC,cAAc,CAAC,IAAI,CAAC,EAAc,IACnD,EADyD,GAClD,GAAW,CAAO,CAAC,EAAI,GAAK,CAAM,CAAC,EAAI,EAAE,AACpD,OAAO,cAAc,CAAC,EAAS,EAAK,CAClC,YAAY,EACZ,IAAK,WACH,OAAO,CAAM,CAAC,EAAI,AACpB,CACF,EACF,GACA,IAAI,EAAQ,AAaZ,SAAS,AAAwB,CAAC,EAAG,EAAI,GAAI,AAAM,CAAL,EAAU,EAAE,UAAU,CAAE,OAAO,EAAG,GAAI,OAAS,GAAK,UAAY,OAAO,GAAK,YAAc,OAAO,EAAG,MAAO,CAAE,QAAS,CAAE,EAAG,IAAI,EAAI,EAA7I,QAA0K,GAAI,GAAK,EAAE,GAAG,CAAC,GAAI,AAAvB,OAA8B,EAAE,GAAG,CAAC,GAAI,IAAI,EAAI,CAAE,UAAW,IAAK,EAAG,EAAI,OAAO,cAAc,EAAI,OAAO,wBAAwB,CAAE,IAAK,IAAI,KAAK,EAAG,GAAI,YAAc,GAAK,CAAA,EAAC,CAAA,CAAE,cAAc,CAAC,IAAI,CAAC,EAAG,GAAI,CAAE,IAAI,EAAI,EAAI,OAAO,wBAAwB,CAAC,EAAG,GAAK,KAAM,GAAM,EAAD,CAAG,GAAG,EAAI,EAAE,GAAA,AAAG,EAAI,OAAO,cAAc,CAAC,EAAG,EAAG,GAAK,CAAC,CAAC,EAAE,CAAG,CAAC,CAAC,EAAE,AAAE,CAAE,OAAO,EAAE,OAAO,CAAG,EAAG,GAAK,EAAE,GAAG,CAAC,EAAG,GAAI,CAAG,EAbtjB,EAAA,CAAA,CAAA,QAYZ,SAAS,EAAyB,CAAC,EAAI,GAAI,YAAc,OAAO,QAAS,OAAO,KAAM,IAAI,EAAI,IAAI,QAAW,EAAI,IAAI,QAAW,MAAO,CAAC,EAA2B,SAAU,CAAC,EAAI,OAAO,EAAI,EAAI,EAAG,CAAC,CAAE,EAAI,CAX3M,OAAO,IAAI,CAAC,GAAO,OAAO,CAAC,SAAU,CAAG,EACtC,AAAY,YAAR,GAA6B,cAAc,CAAtB,GACrB,OAAO,SAAS,CAAC,cAAc,CAAC,IAAI,CAAC,EAAc,IACnD,EADyD,GAClD,GAAW,CAAO,CAAC,EAAI,GAAK,CAAK,CAAC,EAAI,EAAE,AACnD,OAAO,cAAc,CAAC,EAAS,EAAK,CAClC,YAAY,EACZ,IAAK,WACH,OAAO,CAAK,CAAC,EAAI,AACnB,CACF,EACF,2BCnCA,IAAA,EAAA,EAAA,CAAA,CAAA,OAqBO,eAAe,EAAY,CAAyB,EACzD,GAAI,CACF,MAAM,EAAA,MAAM,CAAC,WAAW,CAAC,MAAM,CAAC,CAC9B,KAAM,CACJ,OAAQ,EAAO,MAAM,CACrB,SAAU,EAAO,QAAQ,CACzB,SAAU,EAAO,QAAQ,CACzB,OAAQ,EAAO,MAAM,CACrB,OAAQ,EAAO,MAAM,CACrB,SAAU,EAAO,QAAQ,CACzB,YAAa,EAAO,WAAW,CAC/B,SAAU,EAAO,QAAQ,EAAI,CAAC,EAC9B,UAAW,EAAO,SAAS,CAC3B,UAAW,EAAO,SAAS,CAC3B,OAAQ,EAAO,MAAM,CACrB,SAAU,EAAO,QAAQ,AAC3B,CACF,EACF,CAAE,MAAO,EAAO,CACd,QAAQ,KAAK,CAAC,2BAA4B,EAE5C,CACF,CAKO,eAAe,EACpB,CAAgB,CAChB,CAAc,CACd,CAA6D,CAC7D,CAAmB,CACnB,CAAc,CACd,CAAiB,CACjB,CAAsB,CACtB,CAAyB,CACzB,CAAc,EAEd,GAAI,CACF,MAAM,EAAA,MAAM,CAAC,aAAa,CAAC,MAAM,CAAC,CAChC,KAAM,UACJ,SACA,SACA,EACA,cAAe,GAAiB,CAAC,EACjC,SAAU,GAAY,CAAC,EACvB,SAAU,GAAY,EACtB,cAAe,GAAiB,EAChC,iBAAkB,GAAoB,QACtC,CACF,CACF,EACF,CAAE,MAAO,EAAO,CACd,QAAQ,KAAK,CAAC,iCAAkC,EAClD,CACF,CAKO,SAAS,EAAY,CAAgB,EAC1C,IAAM,EAAY,EAAQ,OAAO,CAAC,GAAG,CAAC,mBAChC,EAAS,EAAQ,OAAO,CAAC,GAAG,CAAC,oBAEnC,AAAI,EACK,EAAU,KAAK,CAAC,CADV,GACc,CAAC,EAAE,CAAC,IAAI,GAG9B,QAAU,CACnB,CAKO,SAAS,EAAa,CAAgB,EAC3C,OAAO,EAAQ,OAAO,CAAC,GAAG,CAAC,oBAAiB,CAC9C","ignoreList":[1,2]}