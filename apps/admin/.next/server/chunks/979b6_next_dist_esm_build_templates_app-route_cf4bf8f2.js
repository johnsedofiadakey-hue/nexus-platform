module.exports=[98819,e=>{"use strict";var t=e.i(36674),r=e.i(41118),s=e.i(59617),a=e.i(52171),n=e.i(43408),o=e.i(67620),i=e.i(82397),d=e.i(27688),u=e.i(75897),l=e.i(96582),c=e.i(64108),p=e.i(18505),m=e.i(84130),h=e.i(26866),R=e.i(77048),g=e.i(93695);e.i(3348);var f=e.i(76390),E=e.i(52716),w=e.i(86531),A=e.i(98148),N=e.i(48285),v=e.i(98954),y=e.i(44404);async function x(e,t){try{let r=await (0,A.getServerSession)(N.authOptions);if(!r)return E.NextResponse.json({error:"Unauthorized"},{status:401});let{id:s}=await t.params;if(!s)return E.NextResponse.json({error:"Missing ID"},{status:400});console.log(`Syncing records for Operative: ${s}`);let a={id:s};"SUPER_ADMIN"!==r.user.role&&(a.organizationId=r.user.organizationId);let{searchParams:n}=new URL(e.url),o="true"===n.get("light"),i={shop:{select:{id:!0,name:!0,location:!0,latitude:!0,longitude:!0,radius:!0}},targets:{where:{status:"ACTIVE"},orderBy:{endDate:"desc"}}};o?i.disciplinary={take:30,orderBy:{createdAt:"desc"}}:(i.sales={take:20,orderBy:{createdAt:"desc"}},i.dailyReports={take:50,orderBy:{createdAt:"desc"}},i.attendance={take:30,orderBy:{date:"desc"}},i.leaves={take:50,orderBy:{createdAt:"desc"}},i.disciplinary={take:30,orderBy:{createdAt:"desc"}},i.sentMessages={take:20,orderBy:{createdAt:"desc"}},i.receivedMessages={take:20,orderBy:{createdAt:"desc"}});let d=w.prisma.user.findFirst({where:a,include:i}),u=new Promise((e,t)=>setTimeout(()=>t(Error("Database query timeout")),1e4)),l=await Promise.race([d,u]);if(!l)return console.log(`Member not found with ID: ${s}`),E.NextResponse.json({error:"Member not found",details:`No agent found with ID: ${s}. Check if this person exists in your organization.`},{status:404});let c=l.disciplinary||[],p=[...l.sentMessages||[],...l.receivedMessages||[]].sort((e,t)=>new Date(e.createdAt).getTime()-new Date(t.createdAt).getTime()),m=c.filter(e=>"GEOFENCE_BREACH"===e.type).reduce((e,t)=>{let r=t.createdAt||new Date,s=new Date(r).toLocaleDateString("en-US",{weekday:"short"}),a=e.find(e=>e.name===s);return a?a.breaches+=1:e.push({name:s,breaches:1}),e},[]);return E.NextResponse.json({...l,disciplinaryLog:c,messages:p,geofenceStats:m,viewerId:r.user.id,targets:l.targets||[]})}catch(e){if(console.error("System Sync Error:",e),console.error("Error Details:",{message:e.message,code:e.code,meta:e.meta,stack:e.stack?.split("\n").slice(0,3).join("\n")}),e.message?.includes("Can't reach database server")||e.message?.includes("ECONNREFUSED")||e.message?.includes("getaddrinfo")||"P1001"===e.code)return E.NextResponse.json({error:"Database connection failed",code:"DB_CONNECTION_ERROR",details:"Cannot reach database server. Please verify DATABASE_URL is configured correctly in environment variables.",hint:"Check .env file or run: ./setup-nexus.sh"},{status:503});if(e.message?.includes("prepared statement"))return E.NextResponse.json({error:"Database Connection Refused. System cache desync.",code:"PG_POOLER_RESET",details:e.message},{status:503});if("P2021"===e.code||e.message?.includes("does not exist"))return E.NextResponse.json({error:"Database schema out of sync. Migration required.",code:"SCHEMA_MISMATCH",details:"Run: npx prisma db push",hint:e.message},{status:503});if(e.message?.includes("Environment variable")||e.message?.includes("DATABASE_URL"))return E.NextResponse.json({error:"Database not configured",code:"ENV_MISSING",details:"DATABASE_URL environment variable is not set. Please configure your database connection.",hint:"Create/edit .env file with DATABASE_URL or run: ./setup-nexus.sh"},{status:503});return E.NextResponse.json({error:"Failed to sync records",details:e.message,code:e.code||"UNKNOWN"},{status:500})}}async function b(e,t){try{let r=await (0,A.getServerSession)(N.authOptions);if(!r)return E.NextResponse.json({error:"Unauthorized"},{status:401});let{id:s}=await t.params,{action:a,...n}=await e.json(),o={id:s};"SUPER_ADMIN"!==r.user.role&&(o.organizationId=r.user.organizationId);let i=await w.prisma.user.findFirst({where:o});if(!i)return E.NextResponse.json({error:"Access Denied"},{status:403});if("UPDATE_PROFILE"===a){let t={name:n.name,email:n.email?.toLowerCase().trim(),phone:n.phone,status:n.status,shopId:n.shopId||null,bypassGeofence:n.bypassGeofence,bankName:n.bankName||null,bankAccountNumber:n.bankAccountNumber||null,bankAccountName:n.bankAccountName||null,ssnitNumber:n.ssnitNumber||null};if(n.shopId&&n.shopId!==i.shopId){let e=await w.prisma.shop.findUnique({where:{id:n.shopId},select:{organizationId:!0}});e&&(t.organizationId=e.organizationId)}if(n.commencementDate){let e=new Date(n.commencementDate);isNaN(e.getTime())||(t.commencementDate=e)}else t.commencementDate=null;n.password&&n.password.length>0&&(t.password=await v.default.hash(n.password,12));let a=await w.prisma.user.update({where:{id:s},data:t});return await (0,y.logActivity)({userId:r.user.id,userName:r.user.name||"Unknown",userRole:r.user.role||"USER",action:"USER_UPDATED",entity:"User",entityId:s,description:`Updated profile for "${a.name}"`,metadata:{targetUserId:s,changes:n},ipAddress:(0,y.getClientIp)(e),userAgent:(0,y.getUserAgent)(e)}),E.NextResponse.json({success:!0,data:a})}if("RESET_PASSWORD"===a){if(!n.password)return E.NextResponse.json({error:"Password required"},{status:400});let e=await v.default.hash(n.password,12);return await w.prisma.user.update({where:{id:s},data:{password:e}}),E.NextResponse.json({success:!0})}if("MANAGE_LEAVE"===a)return await w.prisma.leaveRequest.update({where:{id:n.leaveId},data:{status:n.status}}),E.NextResponse.json({success:!0});return E.NextResponse.json({error:"Action protocol undefined"},{status:400})}catch(e){return console.error("Administrative Override Failure:",e.message),E.NextResponse.json({error:"Database rejected the override"},{status:500})}}async function C(e,t){try{let r=await (0,A.getServerSession)(N.authOptions);if(!r||!r.user||!r.user.organizationId)return E.NextResponse.json({error:"Unauthorized"},{status:401});let{id:s}=await t.params,a={id:s};"SUPER_ADMIN"!==r.user.role&&(a.organizationId=r.user.organizationId);let n=await w.prisma.user.findFirst({where:a});if(!n)return E.NextResponse.json({error:"Access Denied"},{status:403});return await w.prisma.user.delete({where:{id:s}}),await (0,y.logActivity)({userId:r.user.id,userName:r.user.name||"Unknown",userRole:r.user.role||"USER",action:"USER_DELETED",entity:"User",entityId:s,description:`Deleted user "${n.name}"`,metadata:{deletedUserId:s,deletedUserName:n.name,deletedUserEmail:n.email},ipAddress:(0,y.getClientIp)(e),userAgent:(0,y.getUserAgent)(e)}),E.NextResponse.json({success:!0})}catch(e){return console.error("Purge Error:",e.message),E.NextResponse.json({error:"Failed to remove personnel"},{status:500})}}e.s(["DELETE",()=>C,"GET",()=>x,"PATCH",()=>b],57593);var D=e.i(57593);let I=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/hr/member/[id]/route",pathname:"/api/hr/member/[id]",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/apps/admin/src/app/api/hr/member/[id]/route.ts",nextConfigOutput:"",userland:D}),{workAsyncStorage:S,workUnitAsyncStorage:U,serverHooks:T}=I;function P(){return(0,s.patchFetch)({workAsyncStorage:S,workUnitAsyncStorage:U})}async function _(e,t,s){I.isDev&&(0,a.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let E="/api/hr/member/[id]/route";E=E.replace(/\/index$/,"")||"/";let w=await I.prepare(e,t,{srcPage:E,multiZoneDraftMode:!1});if(!w)return t.statusCode=400,t.end("Bad Request"),null==s.waitUntil||s.waitUntil.call(s,Promise.resolve()),null;let{buildId:A,params:N,nextConfig:v,parsedUrl:y,isDraftMode:x,prerenderManifest:b,routerServerContext:C,isOnDemandRevalidate:D,revalidateOnlyGenerated:S,resolvedPathname:U,clientReferenceManifest:T,serverActionsManifest:P}=w,_=(0,i.normalizeAppPath)(E),O=!!(b.dynamicRoutes[_]||b.routes[U]),k=async()=>((null==C?void 0:C.render404)?await C.render404(e,t,y,!1):t.end("This page could not be found"),null);if(O&&!x){let e=!!b.routes[U],t=b.dynamicRoutes[_];if(t&&!1===t.fallback&&!e){if(v.experimental.adapterPath)return await k();throw new g.NoFallbackError}}let j=null;!O||I.isDev||x||(j="/index"===(j=U)?"/":j);let M=!0===I.isDev||!O,H=O&&!M;P&&T&&(0,o.setManifestsSingleton)({page:E,clientReferenceManifest:T,serverActionsManifest:P});let B=e.method||"GET",q=(0,n.getTracer)(),F=q.getActiveScopeSpan(),L={params:N,prerenderManifest:b,renderOpts:{experimental:{authInterrupts:!!v.experimental.authInterrupts},cacheComponents:!!v.cacheComponents,supportsDynamicResponse:M,incrementalCache:(0,a.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:v.cacheLife,waitUntil:s.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,s,a)=>I.onRequestError(e,t,s,a,C)},sharedContext:{buildId:A}},z=new d.NodeNextRequest(e),$=new d.NodeNextResponse(t),G=u.NextRequestAdapter.fromNodeNextRequest(z,(0,u.signalFromNodeResponse)(t));try{let o=async e=>I.handle(G,L).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=q.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==l.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let s=r.get("next.route");if(s){let t=`${B} ${s}`;e.setAttributes({"next.route":s,"http.route":s,"next.span_name":t}),e.updateName(t)}else e.updateName(`${B} ${E}`)}),i=!!(0,a.getRequestMeta)(e,"minimalMode"),d=async a=>{var n,d;let u=async({previousCacheEntry:r})=>{try{if(!i&&D&&S&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await o(a);e.fetchMetrics=L.renderOpts.fetchMetrics;let d=L.renderOpts.pendingWaitUntil;d&&s.waitUntil&&(s.waitUntil(d),d=void 0);let u=L.renderOpts.collectedTags;if(!O)return await (0,p.sendResponse)(z,$,n,L.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(n.headers);u&&(t[R.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==L.renderOpts.collectedRevalidate&&!(L.renderOpts.collectedRevalidate>=R.INFINITE_CACHE)&&L.renderOpts.collectedRevalidate,s=void 0===L.renderOpts.collectedExpire||L.renderOpts.collectedExpire>=R.INFINITE_CACHE?void 0:L.renderOpts.collectedExpire;return{value:{kind:f.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:s}}}}catch(t){throw(null==r?void 0:r.isStale)&&await I.onRequestError(e,t,{routerKind:"App Router",routePath:E,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:D})},!1,C),t}},l=await I.handleResponse({req:e,nextConfig:v,cacheKey:j,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:b,isRoutePPREnabled:!1,isOnDemandRevalidate:D,revalidateOnlyGenerated:S,responseGenerator:u,waitUntil:s.waitUntil,isMinimalMode:i});if(!O)return null;if((null==l||null==(n=l.value)?void 0:n.kind)!==f.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(d=l.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||t.setHeader("x-nextjs-cache",D?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),x&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let g=(0,m.fromNodeOutgoingHttpHeaders)(l.value.headers);return i&&O||g.delete(R.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||t.getHeader("Cache-Control")||g.get("Cache-Control")||g.set("Cache-Control",(0,h.getCacheControlHeader)(l.cacheControl)),await (0,p.sendResponse)(z,$,new Response(l.value.body,{headers:g,status:l.value.status||200})),null};F?await d(F):await q.withPropagatedContext(e.headers,()=>q.trace(l.BaseServerSpan.handleRequest,{spanName:`${B} ${E}`,kind:n.SpanKind.SERVER,attributes:{"http.method":B,"http.target":e.url}},d))}catch(t){if(t instanceof g.NoFallbackError||await I.onRequestError(e,t,{routerKind:"App Router",routePath:_,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:D})},!1,C),O)throw t;return await (0,p.sendResponse)(z,$,new Response(null,{status:500})),null}}e.s(["handler",()=>_,"patchFetch",()=>P,"routeModule",()=>I,"serverHooks",()=>T,"workAsyncStorage",()=>S,"workUnitAsyncStorage",()=>U],98819)}];

//# sourceMappingURL=979b6_next_dist_esm_build_templates_app-route_cf4bf8f2.js.map