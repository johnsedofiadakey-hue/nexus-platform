module.exports=[67492,e=>{"use strict";var t=e.i(36674),r=e.i(41118),a=e.i(59617),s=e.i(52171),o=e.i(43408),n=e.i(67620),i=e.i(82397),d=e.i(27688),u=e.i(75897),l=e.i(96582),p=e.i(64108),c=e.i(18505),h=e.i(84130),m=e.i(26866),R=e.i(77048),g=e.i(93695);e.i(3348);var E=e.i(76390),w=e.i(52716),N=e.i(86531),I=e.i(44257),f=e.i(48285),y=e.i(44404);async function A(e,t){let{id:r}=await t.params;try{let e=await (0,I.getServerSession)(f.authOptions);if(!e||!e.user||!e.user.id)return w.NextResponse.json({error:"Unauthorized"},{status:401});let t="SUPER_ADMIN"===e.user.role;if(!t&&!e.user.organizationId)return w.NextResponse.json({error:"Unauthorized"},{status:401});let a=t?{id:r}:{id:r,organizationId:e.user.organizationId},s=await N.prisma.shop.findFirst({where:a,include:{users:{select:{id:!0,name:!0,role:!0}},products:{orderBy:{updatedAt:"desc"}}}});if(!s)return w.NextResponse.json({error:"Shop not found"},{status:404});let o={...s,staff:s.users,inventory:s.products};return w.NextResponse.json(o)}catch(e){return console.error("GET Shop Error:",e),w.NextResponse.json({error:"Sync Error"},{status:500})}}async function v(e,t){let{id:r}=await t.params;try{let t=await (0,I.getServerSession)(f.authOptions);if(!t||!t.user||!t.user.organizationId)return w.NextResponse.json({error:"Unauthorized"},{status:401});let{name:a,location:s,managerName:o,managerContact:n,radius:i,latitude:d,longitude:u}=await e.json(),l=await N.prisma.shop.update({where:{id:r},data:{name:a,location:s,managerName:o,managerContact:n,radius:i?parseInt(i):void 0,latitude:d?parseFloat(d):void 0,longitude:u?parseFloat(u):void 0}});return await (0,y.logActivity)({userId:t.user.id,userName:t.user.name||"Unknown",userRole:t.user.role||"USER",action:"SHOP_UPDATED",entity:"Shop",entityId:r,description:`Updated shop details for "${a||l.name}"`,metadata:{shopId:r,changes:{name:a,location:s,managerName:o,managerContact:n,radius:i}},ipAddress:(0,y.getClientIp)(e),userAgent:(0,y.getUserAgent)(e),shopId:r,shopName:a||l.name}),w.NextResponse.json({success:!0,data:l})}catch(e){return console.error("âŒ SHOP_UPDATE_ERROR:",e),w.NextResponse.json({error:"Failed to update shop"},{status:500})}}async function S(e,t){let{id:r}=await t.params;try{let t=await (0,I.getServerSession)(f.authOptions);if(!t||!t.user||!t.user.id)return w.NextResponse.json({error:"Unauthorized"},{status:401});let a="SUPER_ADMIN"===t.user.role;if(!a&&!t.user.organizationId)return w.NextResponse.json({error:"Unauthorized"},{status:401});let s=a?{id:r}:{id:r,organizationId:t.user.organizationId};if(!await N.prisma.shop.findFirst({where:s}))return w.NextResponse.json({error:"Shop not found or access denied"},{status:403});let o=await e.json();console.log(`
ðŸ“¦ INVENTORY ACTION [Shop: ${r}]`,o);let n=o.reason||"MANUAL_UPDATE",i=t.user.id,d=parseFloat(o.priceGHS||o.price||"0"),u=parseInt(o.quantity||o.stockLevel||"0"),l=parseInt(o.minStock||"5"),p=o.productName||o.name,c=o.subCategory||"Unsorted",h=o.modelNumber||"",m=o.description||o.notes||"";if(isNaN(d)||!p)return w.NextResponse.json({error:"Invalid Price or Name"},{status:400});if(o.id){console.log(`ðŸ”„ UPDATING ITEM: ${o.id}`);let e=await N.prisma.product.update({where:{id:o.id},data:{name:p,modelNumber:h,description:m,barcode:o.sku,sellingPrice:d,stockLevel:u,minStock:l,category:o.category||"General",subCategory:c}});return await N.prisma.auditLog.create({data:{userId:i,action:"UPDATE_STOCK",entity:"Product",entityId:e.id,details:JSON.stringify({reason:n,oldStock:"?",newStock:u,price:d})}}),w.NextResponse.json({success:!0,data:e,message:"Inventory Updated",audit:{date:e.updatedAt,newTotal:e.stockLevel}})}console.log(`âœ¨ CREATING NEW ITEM`);let R=o.sku&&o.sku.length>2?o.sku:`SKU-${Date.now().toString().slice(-6)}`;if(await N.prisma.product.findFirst({where:{barcode:R,shopId:r}}))return w.NextResponse.json({error:`Barcode ${R} already exists.`},{status:409});let g=await N.prisma.product.create({data:{shopId:r,name:p,modelNumber:h,description:m,barcode:R,sellingPrice:d,buyingPrice:0,stockLevel:u,minStock:l,category:o.category||"General",subCategory:c}});return await N.prisma.auditLog.create({data:{userId:i,action:"CREATE_stock",entity:"Product",entityId:g.id,details:JSON.stringify({reason:"INITIAL_STOCK",qty:u,price:d})}}),w.NextResponse.json({success:!0,data:g,message:"Item Added",audit:{date:g.createdAt,qtyAdded:g.stockLevel}})}catch(e){if(console.error("âŒ TRANSACTION FAILED:",e),"P2002"===e.code)return w.NextResponse.json({error:"This Barcode/SKU is already taken."},{status:409});return w.NextResponse.json({error:e.message||"Database Error"},{status:500})}}async function x(e,t){let{id:r}=await t.params;try{let t=await (0,I.getServerSession)(f.authOptions);if(!t||!t.user||!t.user.organizationId)return w.NextResponse.json({error:"Unauthorized"},{status:401});let a=await N.prisma.shop.findFirst({where:{id:r,organizationId:t.user.organizationId}});if(!a)return w.NextResponse.json({error:"Access denied"},{status:403});let s=null;try{let t=await e.text();s=t?JSON.parse(t):null}catch(e){}if(s&&"INVENTORY"===s.type&&s.id){console.log(`ðŸ—‘ï¸ DELETING STOCK ITEM: ${s.id}`);let o=await N.prisma.product.findFirst({where:{id:s.id,shopId:r}});if(!o)return w.NextResponse.json({error:"Item not found in this shop"},{status:404});return await N.prisma.product.delete({where:{id:s.id}}),await (0,y.logActivity)({userId:t.user.id,userName:t.user.name||"Unknown",userRole:t.user.role||"USER",action:"PRODUCT_DELETED",entity:"Product",entityId:s.id,description:`Deleted product "${o.name}" from inventory`,metadata:{productId:s.id,productName:o.name},ipAddress:(0,y.getClientIp)(e),userAgent:(0,y.getUserAgent)(e),shopId:r,shopName:a.name}),w.NextResponse.json({success:!0,message:"Item deleted"})}return console.log(`ðŸ”¥ DELETING SHOP: ${r}`),await N.prisma.$transaction([N.prisma.sale.deleteMany({where:{shopId:r}}),N.prisma.expense.deleteMany({where:{shopId:r}}),N.prisma.customer.deleteMany({where:{shopId:r}}),N.prisma.product.deleteMany({where:{shopId:r}}),N.prisma.user.updateMany({where:{shopId:r},data:{shopId:null}}),N.prisma.shop.delete({where:{id:r}})]),await (0,y.logActivity)({userId:t.user.id,userName:t.user.name||"Unknown",userRole:t.user.role||"USER",action:"SHOP_DELETED",entity:"Shop",entityId:r,description:`Deleted shop "${a.name}" and all associated data`,metadata:{shopId:r,shopName:a.name},ipAddress:(0,y.getClientIp)(e),userAgent:(0,y.getUserAgent)(e),shopId:r,shopName:a.name}),w.NextResponse.json({success:!0,message:"Shop and all related data purged."})}catch(e){return console.error("âŒ DELETE FAILED:",e),w.NextResponse.json({error:"Delete operation failed."},{status:500})}}e.s(["DELETE",()=>x,"GET",()=>A,"PATCH",()=>v,"POST",()=>S],1321);var T=e.i(1321);let C=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/shops/[id]/route",pathname:"/api/shops/[id]",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/apps/admin/src/app/api/shops/[id]/route.ts",nextConfigOutput:"",userland:T}),{workAsyncStorage:P,workUnitAsyncStorage:U,serverHooks:O}=C;function D(){return(0,a.patchFetch)({workAsyncStorage:P,workUnitAsyncStorage:U})}async function b(e,t,a){C.isDev&&(0,s.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let w="/api/shops/[id]/route";w=w.replace(/\/index$/,"")||"/";let N=await C.prepare(e,t,{srcPage:w,multiZoneDraftMode:!1});if(!N)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:I,params:f,nextConfig:y,parsedUrl:A,isDraftMode:v,prerenderManifest:S,routerServerContext:x,isOnDemandRevalidate:T,revalidateOnlyGenerated:P,resolvedPathname:U,clientReferenceManifest:O,serverActionsManifest:D}=N,b=(0,i.normalizeAppPath)(w),j=!!(S.dynamicRoutes[b]||S.routes[U]),k=async()=>((null==x?void 0:x.render404)?await x.render404(e,t,A,!1):t.end("This page could not be found"),null);if(j&&!v){let e=!!S.routes[U],t=S.dynamicRoutes[b];if(t&&!1===t.fallback&&!e){if(y.experimental.adapterPath)return await k();throw new g.NoFallbackError}}let _=null;!j||C.isDev||v||(_="/index"===(_=U)?"/":_);let H=!0===C.isDev||!j,M=j&&!H;D&&O&&(0,n.setManifestsSingleton)({page:w,clientReferenceManifest:O,serverActionsManifest:D});let L=e.method||"GET",F=(0,o.getTracer)(),$=F.getActiveScopeSpan(),z={params:f,prerenderManifest:S,renderOpts:{experimental:{authInterrupts:!!y.experimental.authInterrupts},cacheComponents:!!y.cacheComponents,supportsDynamicResponse:H,incrementalCache:(0,s.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:y.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a,s)=>C.onRequestError(e,t,a,s,x)},sharedContext:{buildId:I}},q=new d.NodeNextRequest(e),K=new d.NodeNextResponse(t),G=u.NextRequestAdapter.fromNodeNextRequest(q,(0,u.signalFromNodeResponse)(t));try{let n=async e=>C.handle(G,z).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=F.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==l.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${L} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${L} ${w}`)}),i=!!(0,s.getRequestMeta)(e,"minimalMode"),d=async s=>{var o,d;let u=async({previousCacheEntry:r})=>{try{if(!i&&T&&P&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let o=await n(s);e.fetchMetrics=z.renderOpts.fetchMetrics;let d=z.renderOpts.pendingWaitUntil;d&&a.waitUntil&&(a.waitUntil(d),d=void 0);let u=z.renderOpts.collectedTags;if(!j)return await (0,c.sendResponse)(q,K,o,z.renderOpts.pendingWaitUntil),null;{let e=await o.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(o.headers);u&&(t[R.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==z.renderOpts.collectedRevalidate&&!(z.renderOpts.collectedRevalidate>=R.INFINITE_CACHE)&&z.renderOpts.collectedRevalidate,a=void 0===z.renderOpts.collectedExpire||z.renderOpts.collectedExpire>=R.INFINITE_CACHE?void 0:z.renderOpts.collectedExpire;return{value:{kind:E.CachedRouteKind.APP_ROUTE,status:o.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await C.onRequestError(e,t,{routerKind:"App Router",routePath:w,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:T})},!1,x),t}},l=await C.handleResponse({req:e,nextConfig:y,cacheKey:_,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:S,isRoutePPREnabled:!1,isOnDemandRevalidate:T,revalidateOnlyGenerated:P,responseGenerator:u,waitUntil:a.waitUntil,isMinimalMode:i});if(!j)return null;if((null==l||null==(o=l.value)?void 0:o.kind)!==E.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(d=l.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||t.setHeader("x-nextjs-cache",T?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),v&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let g=(0,h.fromNodeOutgoingHttpHeaders)(l.value.headers);return i&&j||g.delete(R.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||t.getHeader("Cache-Control")||g.get("Cache-Control")||g.set("Cache-Control",(0,m.getCacheControlHeader)(l.cacheControl)),await (0,c.sendResponse)(q,K,new Response(l.value.body,{headers:g,status:l.value.status||200})),null};$?await d($):await F.withPropagatedContext(e.headers,()=>F.trace(l.BaseServerSpan.handleRequest,{spanName:`${L} ${w}`,kind:o.SpanKind.SERVER,attributes:{"http.method":L,"http.target":e.url}},d))}catch(t){if(t instanceof g.NoFallbackError||await C.onRequestError(e,t,{routerKind:"App Router",routePath:b,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:T})},!1,x),j)throw t;return await (0,c.sendResponse)(q,K,new Response(null,{status:500})),null}}e.s(["handler",()=>b,"patchFetch",()=>D,"routeModule",()=>C,"serverHooks",()=>O,"workAsyncStorage",()=>P,"workUnitAsyncStorage",()=>U],67492)}];

//# sourceMappingURL=979b6_next_dist_esm_build_templates_app-route_9d2693cb.js.map