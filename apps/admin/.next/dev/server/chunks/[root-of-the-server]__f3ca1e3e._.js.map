{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 106, "column": 0}, "map": {"version":3,"sources":["file:///workspaces/nexus-platform/apps/admin/src/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\";\n\n/**\n * üõ°Ô∏è SECURE PRISMA CLIENT CONFIGURATION\n * \n * Database: Supabase PostgreSQL (Transaction Pooler)\n * Connection: Uses environment variables for security\n * Mode: Transaction pooling (pgbouncer=true required)\n */\n\nconst globalForPrisma = global as unknown as { prisma: PrismaClient | undefined };\n\nfunction getPrismaClient() {\n  if (globalForPrisma.prisma) {\n    return globalForPrisma.prisma;\n  }\n\n  // Build time: return a dummy client that will fail at runtime if used\n  if (!process.env.DATABASE_URL) {\n    // During build, create a minimal client that won't actually connect\n    const client = new PrismaClient({\n      log: [],\n    });\n    \n    if (process.env.NODE_ENV !== \"production\") {\n      globalForPrisma.prisma = client;\n    }\n    \n    return client;\n  }\n\n  // Runtime: create properly configured client\n  const baseUrl = process.env.DATABASE_URL;\n  const connectionUrl = baseUrl.includes(\"?\")\n    ? `${baseUrl}&pgbouncer=true&connection_limit=1`\n    : `${baseUrl}?pgbouncer=true&connection_limit=1`;\n\n  const client = new PrismaClient({\n    datasources: {\n      db: {\n        url: connectionUrl,\n      },\n    },\n    log: process.env.NODE_ENV === \"development\" ? [\"error\", \"warn\"] : [\"error\"],\n  });\n\n  if (process.env.NODE_ENV !== \"production\") {\n    globalForPrisma.prisma = client;\n  }\n\n  return client;\n}\n\nexport const prisma = getPrismaClient();"],"names":[],"mappings":";;;;AAAA;;AAEA;;;;;;CAMC,GAED,MAAM;AAEN,SAAS;IACP,IAAI,gBAAgB,MAAM,EAAE;QAC1B,OAAO,gBAAgB,MAAM;IAC/B;IAEA,sEAAsE;IACtE,IAAI,CAAC,QAAQ,GAAG,CAAC,YAAY,EAAE;QAC7B,oEAAoE;QACpE,MAAM,SAAS,IAAI,sMAAY,CAAC;YAC9B,KAAK,EAAE;QACT;QAEA,wCAA2C;YACzC,gBAAgB,MAAM,GAAG;QAC3B;QAEA,OAAO;IACT;IAEA,6CAA6C;IAC7C,MAAM,UAAU,QAAQ,GAAG,CAAC,YAAY;IACxC,MAAM,gBAAgB,QAAQ,QAAQ,CAAC,OACnC,GAAG,QAAQ,kCAAkC,CAAC,GAC9C,GAAG,QAAQ,kCAAkC,CAAC;IAElD,MAAM,SAAS,IAAI,sMAAY,CAAC;QAC9B,aAAa;YACX,IAAI;gBACF,KAAK;YACP;QACF;QACA,KAAK,uCAAyC;YAAC;YAAS;SAAO,GAAG;IACpE;IAEA,wCAA2C;QACzC,gBAAgB,MAAM,GAAG;IAC3B;IAEA,OAAO;AACT;AAEO,MAAM,SAAS"}},
    {"offset": {"line": 158, "column": 0}, "map": {"version":3,"sources":["file:///workspaces/nexus-platform/apps/admin/src/lib/auth.ts"],"sourcesContent":["import { NextAuthOptions } from \"next-auth\";\nimport CredentialsProvider from \"next-auth/providers/credentials\";\nimport { prisma } from \"@/lib/prisma\";\nimport { compare } from \"bcryptjs\";\n\n// Check for required environment variables\nif (!process.env.NEXTAUTH_SECRET) {\n  console.error(\"‚ùå CRITICAL: NEXTAUTH_SECRET is not set!\");\n  console.error(\"Generate one with: openssl rand -base64 32\");\n}\n\nif (!process.env.DATABASE_URL) {\n  console.error(\"‚ùå CRITICAL: DATABASE_URL is not set!\");\n}\n\n// üö® CRITICAL: Check NEXTAUTH_URL for deployment\nif (!process.env.NEXTAUTH_URL) {\n  console.error(\"‚ö†Ô∏è  WARNING: NEXTAUTH_URL is not set!\");\n  console.error(\"This can cause refresh loops in production.\");\n  console.error(\"Set it to your deployment URL: https://your-app.vercel.app\");\n} else if (process.env.NEXTAUTH_URL.includes('localhost') && process.env.NODE_ENV === 'production') {\n  console.error(\"üî¥ CRITICAL ERROR: NEXTAUTH_URL is set to localhost in production!\");\n  console.error(\"Current value:\", process.env.NEXTAUTH_URL);\n  console.error(\"This WILL cause refresh loops. Update to your actual domain!\");\n}\n\nexport const authOptions: NextAuthOptions = {\n  debug: process.env.NODE_ENV === 'development',\n\n  // üîí TRUST HOST for Vercel/production deployments\n  // This prevents callback URL mismatches\n  trustHost: true,\n\n  // üç™ FORCE COOKIES TO STICK (Critical for localhost)\n  cookies: {\n    sessionToken: {\n      name: `next-auth.session-token`,\n      options: {\n        httpOnly: true,\n        sameSite: 'lax',\n        path: '/',\n        secure: process.env.NODE_ENV === 'production'\n      }\n    }\n  },\n\n  session: { \n    strategy: \"jwt\",\n    maxAge: 30 * 24 * 60 * 60, // 30 days\n  },\n\n  secret: process.env.NEXTAUTH_SECRET,\n\n  providers: [\n    CredentialsProvider({\n      name: \"Credentials\",\n      credentials: {\n        email: { label: \"Email\", type: \"email\" },\n        password: { label: \"Password\", type: \"password\" }\n      },\n      async authorize(credentials) {\n        if (!credentials?.email || !credentials?.password) return null;\n\n        try {\n          // 1. Find User\n          const user = await prisma.user.findUnique({\n            where: { email: credentials.email.toLowerCase() }\n          });\n\n          if (!user) {\n            console.log(\"User not found:\", credentials.email);\n            return null;\n          }\n\n          // 2. üõ°Ô∏è SECURE PASSWORD CHECK (Bcrypt)\n          const isValid = await compare(credentials.password, user.password);\n\n          if (!isValid) {\n            console.log(\"Invalid password for user:\", credentials.email);\n            return null;\n          }\n\n          console.log(\"‚úÖ User authenticated:\", user.email);\n          \n          return {\n            id: user.id,\n            email: user.email,\n            name: user.name,\n            role: user.role,\n            organizationId: user.organizationId,\n            bankName: user.bankName,\n            bankAccountNumber: user.bankAccountNumber,\n            bankAccountName: user.bankAccountName,\n            ssnitNumber: user.ssnitNumber,\n            commencementDate: user.commencementDate,\n            ghanaCard: user.ghanaCard,\n            dob: user.dob\n          };\n        } catch (error) {\n          console.error(\"‚ùå Auth error:\", error);\n          return null;\n        }\n      }\n    })\n  ],\n\n  callbacks: {\n    async jwt({ token, user }) {\n      if (user) {\n        token.role = (user as any).role;\n        token.id = user.id;\n        token.organizationId = (user as any).organizationId;\n        token.bankName = (user as any).bankName;\n        token.bankAccountNumber = (user as any).bankAccountNumber;\n        token.bankAccountName = (user as any).bankAccountName;\n        token.ssnitNumber = (user as any).ssnitNumber;\n        token.commencementDate = (user as any).commencementDate;\n        token.ghanaCard = (user as any).ghanaCard;\n        token.dob = (user as any).dob;\n      }\n      return token;\n    },\n    async session({ session, token }) {\n      if (session.user) {\n        (session.user as any).role = token.role;\n        (session.user as any).id = token.id;\n        (session.user as any).organizationId = token.organizationId;\n        (session.user as any).bankName = token.bankName;\n        (session.user as any).bankAccountNumber = token.bankAccountNumber;\n        (session.user as any).bankAccountName = token.bankAccountName;\n        (session.user as any).ssnitNumber = token.ssnitNumber;\n        (session.user as any).commencementDate = token.commencementDate;\n        (session.user as any).ghanaCard = token.ghanaCard;\n        (session.user as any).dob = token.dob;\n      }\n      return session;\n    }\n  },\n\n  // üö™ CUSTOM PAGES\n  pages: {\n    signIn: '/auth/signin',\n    error: '/auth/signin', // Redirect errors back to login\n  },\n\n  // Add useSecureCookies for production\n  useSecureCookies: process.env.NODE_ENV === 'production',\n};"],"names":[],"mappings":"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"}},
    {"offset": {"line": 303, "column": 0}, "map": {"version":3,"sources":["file:///workspaces/nexus-platform/apps/admin/src/lib/activity-logger.ts"],"sourcesContent":["import { prisma } from \"./prisma\";\n\nexport interface ActivityLogParams {\n  userId: string;\n  userName: string;\n  userRole: string;\n  action: string;\n  entity: string;\n  entityId?: string;\n  description: string;\n  metadata?: any;\n  ipAddress?: string;\n  userAgent?: string;\n  shopId?: string;\n  shopName?: string;\n}\n\n/**\n * Master Activity Logger - Logs all system activities\n * This captures every meaningful action from agents, admins, and all users\n */\nexport async function logActivity(params: ActivityLogParams) {\n  try {\n    await prisma.activityLog.create({\n      data: {\n        userId: params.userId,\n        userName: params.userName,\n        userRole: params.userRole,\n        action: params.action,\n        entity: params.entity,\n        entityId: params.entityId,\n        description: params.description,\n        metadata: params.metadata || {},\n        ipAddress: params.ipAddress,\n        userAgent: params.userAgent,\n        shopId: params.shopId,\n        shopName: params.shopName,\n      },\n    });\n  } catch (error) {\n    console.error(\"‚ùå Activity Logger Error:\", error);\n    // Don't throw - logging failures shouldn't break the main operation\n  }\n}\n\n/**\n * Log target-related activities with history tracking\n */\nexport async function logTargetActivity(\n  targetId: string,\n  userId: string,\n  action: \"CREATED\" | \"UPDATED\" | \"DELETED\" | \"PROGRESS_UPDATE\",\n  previousValue?: any,\n  newValue?: any,\n  progress?: number,\n  achievedValue?: number,\n  achievedQuantity?: number,\n  notes?: string\n) {\n  try {\n    await prisma.targetHistory.create({\n      data: {\n        targetId,\n        userId,\n        action,\n        previousValue: previousValue || {},\n        newValue: newValue || {},\n        progress: progress || 0,\n        achievedValue: achievedValue || 0,\n        achievedQuantity: achievedQuantity || 0,\n        notes,\n      },\n    });\n  } catch (error) {\n    console.error(\"‚ùå Target History Logger Error:\", error);\n  }\n}\n\n/**\n * Helper to get client IP from request headers\n */\nexport function getClientIp(request: Request): string | undefined {\n  const forwarded = request.headers.get(\"x-forwarded-for\");\n  const realIp = request.headers.get(\"x-real-ip\");\n  \n  if (forwarded) {\n    return forwarded.split(\",\")[0].trim();\n  }\n  \n  return realIp || undefined;\n}\n\n/**\n * Helper to get user agent from request headers\n */\nexport function getUserAgent(request: Request): string | undefined {\n  return request.headers.get(\"user-agent\") || undefined;\n}\n"],"names":[],"mappings":";;;;;;;;;;AAAA;;AAqBO,eAAe,YAAY,MAAyB;IACzD,IAAI;QACF,MAAM,iJAAM,CAAC,WAAW,CAAC,MAAM,CAAC;YAC9B,MAAM;gBACJ,QAAQ,OAAO,MAAM;gBACrB,UAAU,OAAO,QAAQ;gBACzB,UAAU,OAAO,QAAQ;gBACzB,QAAQ,OAAO,MAAM;gBACrB,QAAQ,OAAO,MAAM;gBACrB,UAAU,OAAO,QAAQ;gBACzB,aAAa,OAAO,WAAW;gBAC/B,UAAU,OAAO,QAAQ,IAAI,CAAC;gBAC9B,WAAW,OAAO,SAAS;gBAC3B,WAAW,OAAO,SAAS;gBAC3B,QAAQ,OAAO,MAAM;gBACrB,UAAU,OAAO,QAAQ;YAC3B;QACF;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,4BAA4B;IAC1C,oEAAoE;IACtE;AACF;AAKO,eAAe,kBACpB,QAAgB,EAChB,MAAc,EACd,MAA6D,EAC7D,aAAmB,EACnB,QAAc,EACd,QAAiB,EACjB,aAAsB,EACtB,gBAAyB,EACzB,KAAc;IAEd,IAAI;QACF,MAAM,iJAAM,CAAC,aAAa,CAAC,MAAM,CAAC;YAChC,MAAM;gBACJ;gBACA;gBACA;gBACA,eAAe,iBAAiB,CAAC;gBACjC,UAAU,YAAY,CAAC;gBACvB,UAAU,YAAY;gBACtB,eAAe,iBAAiB;gBAChC,kBAAkB,oBAAoB;gBACtC;YACF;QACF;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,kCAAkC;IAClD;AACF;AAKO,SAAS,YAAY,OAAgB;IAC1C,MAAM,YAAY,QAAQ,OAAO,CAAC,GAAG,CAAC;IACtC,MAAM,SAAS,QAAQ,OAAO,CAAC,GAAG,CAAC;IAEnC,IAAI,WAAW;QACb,OAAO,UAAU,KAAK,CAAC,IAAI,CAAC,EAAE,CAAC,IAAI;IACrC;IAEA,OAAO,UAAU;AACnB;AAKO,SAAS,aAAa,OAAgB;IAC3C,OAAO,QAAQ,OAAO,CAAC,GAAG,CAAC,iBAAiB;AAC9C"}},
    {"offset": {"line": 372, "column": 0}, "map": {"version":3,"sources":["file:///workspaces/nexus-platform/apps/admin/src/app/api/targets/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\nimport { getServerSession } from \"next-auth/next\";\nimport { authOptions } from \"@/lib/auth\";\nimport { prisma } from \"@/lib/prisma\";\nimport { logActivity, logTargetActivity, getClientIp, getUserAgent } from \"@/lib/activity-logger\";\n\nexport const dynamic = 'force-dynamic';\n\n// GET: Fetch Targets (All or by User)\nexport async function GET(req: Request) {\n    try {\n        const session = await getServerSession(authOptions);\n        if (!session?.user) {\n            return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\n        }\n\n        const isSuperAdmin = session.user.role === 'SUPER_ADMIN';\n        if (!isSuperAdmin && !session.user.organizationId) {\n            return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\n        }\n\n        const { searchParams } = new URL(req.url);\n        const userId = searchParams.get(\"userId\");\n        const targetType = searchParams.get(\"targetType\");\n        const includeHistory = searchParams.get(\"includeHistory\") === \"true\";\n\n        const whereClause: any = {};\n        if (userId) whereClause.userId = userId;\n        if (targetType) whereClause.targetType = targetType;\n        if (!isSuperAdmin && !userId && !targetType) {\n            whereClause.user = { organizationId: session.user.organizationId };\n        }\n\n        const targets = await prisma.target.findMany({\n            where: whereClause,\n            include: { \n                user: { select: { name: true, image: true, shop: { select: { name: true } } } },\n                history: includeHistory ? { orderBy: { createdAt: 'desc' }, take: 50 } : false\n            },\n            orderBy: { createdAt: \"desc\" }\n        });\n\n        return NextResponse.json(targets);\n    } catch (error: any) {\n        return NextResponse.json({ error: error.message }, { status: 500 });\n    }\n}\n\n// POST: Create Target\nexport async function POST(req: Request) {\n    try {\n        const session = await getServerSession(authOptions);\n        if (!session?.user) {\n            return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\n        }\n\n        const isSuperAdmin = session.user.role === 'SUPER_ADMIN';\n        if (!isSuperAdmin && !session.user.organizationId) {\n            return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\n        }\n\n        const body = await req.json();\n        const { userId, targetQuantity, targetValue, startDate, endDate, targetType, achievedValue, achievedQuantity } = body;\n\n        // For ADMIN targets, use the session user's ID\n        const finalUserId = (targetType === \"ADMIN\" && !userId) ? session.user.id : userId;\n\n        if (!finalUserId) {\n            return NextResponse.json({ error: \"User ID required\" }, { status: 400 });\n        }\n\n        // Fetch target user for shop info\n        const targetUser = await prisma.user.findUnique({\n            where: { id: finalUserId },\n            include: { shop: true }\n        });\n\n        const target = await prisma.target.create({\n            data: {\n                userId: finalUserId,\n                targetQuantity: parseInt(targetQuantity) || 0,\n                targetValue: parseFloat(targetValue) || 0,\n                achievedQuantity: parseInt(achievedQuantity) || 0,\n                achievedValue: parseFloat(achievedValue) || 0,\n                startDate: new Date(startDate),\n                endDate: new Date(endDate),\n                status: \"ACTIVE\",\n                targetType: targetType || \"AGENT\"\n            }\n        });\n\n        // Log target creation in history\n        await logTargetActivity(\n            target.id,\n            session.user.id,\n            \"CREATED\",\n            null,\n            {\n                targetQuantity: target.targetQuantity,\n                targetValue: target.targetValue,\n                startDate: target.startDate,\n                endDate: target.endDate,\n            },\n            0,\n            0,\n            0,\n            `Target created by ${session.user.name}`\n        );\n\n        // Log in master activity log\n        await logActivity({\n            userId: session.user.id,\n            userName: session.user.name || \"Unknown\",\n            userRole: session.user.role || \"USER\",\n            action: \"TARGET_CREATED\",\n            entity: \"Target\",\n            entityId: target.id,\n            description: `Created target for ${targetUser?.name}: ‚Çµ${targetValue} / ${targetQuantity} units`,\n            metadata: { targetId: target.id, userId, targetQuantity, targetValue },\n            ipAddress: getClientIp(req),\n            userAgent: getUserAgent(req),\n            shopId: targetUser?.shopId,\n            shopName: targetUser?.shop?.name,\n        });\n\n        return NextResponse.json(target);\n    } catch (error: any) {\n        return NextResponse.json({ error: error.message }, { status: 500 });\n    }\n}\n\n// PATCH: Update Target\nexport async function PATCH(req: Request) {\n    try {\n        const session = await getServerSession(authOptions);\n        if (!session?.user) {\n            return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\n        }\n\n        const body = await req.json();\n        const { id, targetId, targetQuantity, targetValue, startDate, endDate, status, targetType, achievedValue, achievedQuantity } = body;\n\n        const finalTargetId = id || targetId;\n        if (!finalTargetId) {\n            return NextResponse.json({ error: \"Target ID required\" }, { status: 400 });\n        }\n\n        // Get existing target\n        const existingTarget = await prisma.target.findUnique({\n            where: { id: finalTargetId },\n            include: { user: { include: { shop: true } } }\n        });\n\n        if (!existingTarget) {\n            return NextResponse.json({ error: \"Target not found\" }, { status: 404 });\n        }\n\n        // Update target\n        const updatedTarget = await prisma.target.update({\n            where: { id: finalTargetId },\n            data: {\n                ...(targetQuantity !== undefined && { targetQuantity: parseInt(targetQuantity) }),\n                ...(targetValue !== undefined && { targetValue: parseFloat(targetValue) }),\n                ...(achievedQuantity !== undefined && { achievedQuantity: parseInt(achievedQuantity) }),\n                ...(achievedValue !== undefined && { achievedValue: parseFloat(achievedValue) }),\n                ...(startDate && { startDate: new Date(startDate) }),\n                ...(endDate && { endDate: new Date(endDate) }),\n                ...(status && { status }),\n                ...(targetType && { targetType }),\n            }\n        });\n\n        // Log target update in history\n        await logTargetActivity(\n            finalTargetId,\n            session.user.id,\n            \"UPDATED\",\n            {\n                targetQuantity: existingTarget.targetQuantity,\n                targetValue: existingTarget.targetValue,\n                startDate: existingTarget.startDate,\n                endDate: existingTarget.endDate,\n                status: existingTarget.status,\n            },\n            {\n                targetQuantity: updatedTarget.targetQuantity,\n                targetValue: updatedTarget.targetValue,\n                startDate: updatedTarget.startDate,\n                endDate: updatedTarget.endDate,\n                status: updatedTarget.status,\n            },\n            0,\n            0,\n            0,\n            `Target updated by ${session.user.name}`\n        );\n\n        // Log in master activity log\n        await logActivity({\n            userId: session.user.id,\n            userName: session.user.name || \"Unknown\",\n            userRole: session.user.role || \"USER\",\n            action: \"TARGET_UPDATED\",\n            entity: \"Target\",\n            entityId: finalTargetId,\n            description: `Updated target for ${existingTarget.user.name}`,\n            metadata: { targetId: finalTargetId, changes: body },\n            ipAddress: getClientIp(req),\n            userAgent: getUserAgent(req),\n            shopId: existingTarget.user.shopId,\n            shopName: existingTarget.user.shop?.name,\n        });\n\n        return NextResponse.json(updatedTarget);\n    } catch (error: any) {\n        return NextResponse.json({ error: error.message }, { status: 500 });\n    }\n}\n\n// DELETE: Delete Target\nexport async function DELETE(req: Request) {\n    try {\n        const session = await getServerSession(authOptions);\n        if (!session?.user) {\n            return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\n        }\n\n        const { searchParams } = new URL(req.url);\n        const targetId = searchParams.get(\"id\") || searchParams.get(\"targetId\");\n\n        if (!targetId) {\n            return NextResponse.json({ error: \"Target ID required\" }, { status: 400 });\n        }\n\n        // Get existing target before deletion\n        const existingTarget = await prisma.target.findUnique({\n            where: { id: targetId },\n            include: { user: { include: { shop: true } } }\n        });\n\n        if (!existingTarget) {\n            return NextResponse.json({ error: \"Target not found\" }, { status: 404 });\n        }\n\n        // Log target deletion in history (before deleting)\n        await logTargetActivity(\n            targetId,\n            session.user.id,\n            \"DELETED\",\n            {\n                targetQuantity: existingTarget.targetQuantity,\n                targetValue: existingTarget.targetValue,\n                startDate: existingTarget.startDate,\n                endDate: existingTarget.endDate,\n                status: existingTarget.status,\n            },\n            null,\n            0,\n            0,\n            0,\n            `Target deleted by ${session.user.name}`\n        );\n\n        // Delete target (cascade will handle history)\n        await prisma.target.delete({\n            where: { id: targetId }\n        });\n\n        // Log in master activity log\n        await logActivity({\n            userId: session.user.id,\n            userName: session.user.name || \"Unknown\",\n            userRole: session.user.role || \"USER\",\n            action: \"TARGET_DELETED\",\n            entity: \"Target\",\n            entityId: targetId,\n            description: `Deleted target for ${existingTarget.user.name}`,\n            metadata: { targetId, deletedTarget: existingTarget },\n            ipAddress: getClientIp(req),\n            userAgent: getUserAgent(req),\n            shopId: existingTarget.user.shopId,\n            shopName: existingTarget.user.shop?.name,\n        });\n\n        return NextResponse.json({ success: true, message: \"Target deleted\" });\n    } catch (error: any) {\n        return NextResponse.json({ error: error.message }, { status: 500 });\n    }\n}\n\n"],"names":[],"mappings":"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"}}]
}