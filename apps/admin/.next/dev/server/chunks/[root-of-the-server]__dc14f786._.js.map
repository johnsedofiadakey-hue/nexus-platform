{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///workspaces/nexus-platform/apps/admin/src/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\";\n\n/**\n * üõ°Ô∏è SECURE PRISMA CLIENT CONFIGURATION\n * \n * Database: Supabase PostgreSQL (Transaction Pooler)\n * Connection: Uses environment variables for security\n * Mode: Transaction pooling (pgbouncer=true required)\n */\n\nconst globalForPrisma = global as unknown as { prisma: PrismaClient | undefined };\n\nfunction getPrismaClient() {\n  if (globalForPrisma.prisma) {\n    return globalForPrisma.prisma;\n  }\n\n  // Build time: return a dummy client that will fail at runtime if used\n  if (!process.env.DATABASE_URL) {\n    // During build, create a minimal client that won't actually connect\n    const client = new PrismaClient({\n      log: [],\n    });\n    \n    if (process.env.NODE_ENV !== \"production\") {\n      globalForPrisma.prisma = client;\n    }\n    \n    return client;\n  }\n\n  // Runtime: create properly configured client\n  const baseUrl = process.env.DATABASE_URL;\n  const connectionUrl = baseUrl.includes(\"?\")\n    ? `${baseUrl}&pgbouncer=true&connection_limit=1`\n    : `${baseUrl}?pgbouncer=true&connection_limit=1`;\n\n  const client = new PrismaClient({\n    datasources: {\n      db: {\n        url: connectionUrl,\n      },\n    },\n    log: process.env.NODE_ENV === \"development\" ? [\"error\", \"warn\"] : [\"error\"],\n  });\n\n  if (process.env.NODE_ENV !== \"production\") {\n    globalForPrisma.prisma = client;\n  }\n\n  return client;\n}\n\nexport const prisma = getPrismaClient();"],"names":[],"mappings":";;;;AAAA;;AAEA;;;;;;CAMC,GAED,MAAM;AAEN,SAAS;IACP,IAAI,gBAAgB,MAAM,EAAE;QAC1B,OAAO,gBAAgB,MAAM;IAC/B;IAEA,sEAAsE;IACtE,IAAI,CAAC,QAAQ,GAAG,CAAC,YAAY,EAAE;QAC7B,oEAAoE;QACpE,MAAM,SAAS,IAAI,sMAAY,CAAC;YAC9B,KAAK,EAAE;QACT;QAEA,wCAA2C;YACzC,gBAAgB,MAAM,GAAG;QAC3B;QAEA,OAAO;IACT;IAEA,6CAA6C;IAC7C,MAAM,UAAU,QAAQ,GAAG,CAAC,YAAY;IACxC,MAAM,gBAAgB,QAAQ,QAAQ,CAAC,OACnC,GAAG,QAAQ,kCAAkC,CAAC,GAC9C,GAAG,QAAQ,kCAAkC,CAAC;IAElD,MAAM,SAAS,IAAI,sMAAY,CAAC;QAC9B,aAAa;YACX,IAAI;gBACF,KAAK;YACP;QACF;QACA,KAAK,uCAAyC;YAAC;YAAS;SAAO,GAAG;IACpE;IAEA,wCAA2C;QACzC,gBAAgB,MAAM,GAAG;IAC3B;IAEA,OAAO;AACT;AAEO,MAAM,SAAS"}},
    {"offset": {"line": 158, "column": 0}, "map": {"version":3,"sources":["file:///workspaces/nexus-platform/apps/admin/src/lib/auth.ts"],"sourcesContent":["import { NextAuthOptions } from \"next-auth\";\nimport CredentialsProvider from \"next-auth/providers/credentials\";\nimport { prisma } from \"@/lib/prisma\";\nimport { compare } from \"bcryptjs\";\n\n// Check for required environment variables\nif (!process.env.NEXTAUTH_SECRET) {\n  console.error(\"‚ùå CRITICAL: NEXTAUTH_SECRET is not set!\");\n  console.error(\"Generate one with: openssl rand -base64 32\");\n}\n\nif (!process.env.DATABASE_URL) {\n  console.error(\"‚ùå CRITICAL: DATABASE_URL is not set!\");\n}\n\n// üö® CRITICAL: Check NEXTAUTH_URL for deployment\nif (!process.env.NEXTAUTH_URL) {\n  console.error(\"‚ö†Ô∏è  WARNING: NEXTAUTH_URL is not set!\");\n  console.error(\"This can cause refresh loops in production.\");\n  console.error(\"Set it to your deployment URL: https://your-app.vercel.app\");\n} else if (process.env.NEXTAUTH_URL.includes('localhost') && process.env.NODE_ENV === 'production') {\n  console.error(\"üî¥ CRITICAL ERROR: NEXTAUTH_URL is set to localhost in production!\");\n  console.error(\"Current value:\", process.env.NEXTAUTH_URL);\n  console.error(\"This WILL cause refresh loops. Update to your actual domain!\");\n}\n\nexport const authOptions: NextAuthOptions = {\n  debug: process.env.NODE_ENV === 'development',\n\n  // üîí TRUST HOST for Vercel/production deployments\n  // This prevents callback URL mismatches\n  trustHost: true,\n\n  // üç™ FORCE COOKIES TO STICK (Critical for localhost)\n  cookies: {\n    sessionToken: {\n      name: `next-auth.session-token`,\n      options: {\n        httpOnly: true,\n        sameSite: 'lax',\n        path: '/',\n        secure: process.env.NODE_ENV === 'production'\n      }\n    }\n  },\n\n  session: { \n    strategy: \"jwt\",\n    maxAge: 30 * 24 * 60 * 60, // 30 days\n  },\n\n  secret: process.env.NEXTAUTH_SECRET,\n\n  providers: [\n    CredentialsProvider({\n      name: \"Credentials\",\n      credentials: {\n        email: { label: \"Email\", type: \"email\" },\n        password: { label: \"Password\", type: \"password\" }\n      },\n      async authorize(credentials) {\n        if (!credentials?.email || !credentials?.password) return null;\n\n        try {\n          // 1. Find User\n          const user = await prisma.user.findUnique({\n            where: { email: credentials.email.toLowerCase() }\n          });\n\n          if (!user) {\n            console.log(\"User not found:\", credentials.email);\n            return null;\n          }\n\n          // 2. üõ°Ô∏è SECURE PASSWORD CHECK (Bcrypt)\n          const isValid = await compare(credentials.password, user.password);\n\n          if (!isValid) {\n            console.log(\"Invalid password for user:\", credentials.email);\n            return null;\n          }\n\n          console.log(\"‚úÖ User authenticated:\", user.email);\n          \n          return {\n            id: user.id,\n            email: user.email,\n            name: user.name,\n            role: user.role,\n            organizationId: user.organizationId,\n            bankName: user.bankName,\n            bankAccountNumber: user.bankAccountNumber,\n            bankAccountName: user.bankAccountName,\n            ssnitNumber: user.ssnitNumber,\n            commencementDate: user.commencementDate,\n            ghanaCard: user.ghanaCard,\n            dob: user.dob\n          };\n        } catch (error) {\n          console.error(\"‚ùå Auth error:\", error);\n          return null;\n        }\n      }\n    })\n  ],\n\n  callbacks: {\n    async jwt({ token, user }) {\n      if (user) {\n        token.role = (user as any).role;\n        token.id = user.id;\n        token.organizationId = (user as any).organizationId;\n        token.bankName = (user as any).bankName;\n        token.bankAccountNumber = (user as any).bankAccountNumber;\n        token.bankAccountName = (user as any).bankAccountName;\n        token.ssnitNumber = (user as any).ssnitNumber;\n        token.commencementDate = (user as any).commencementDate;\n        token.ghanaCard = (user as any).ghanaCard;\n        token.dob = (user as any).dob;\n      }\n      return token;\n    },\n    async session({ session, token }) {\n      if (session.user) {\n        (session.user as any).role = token.role;\n        (session.user as any).id = token.id;\n        (session.user as any).organizationId = token.organizationId;\n        (session.user as any).bankName = token.bankName;\n        (session.user as any).bankAccountNumber = token.bankAccountNumber;\n        (session.user as any).bankAccountName = token.bankAccountName;\n        (session.user as any).ssnitNumber = token.ssnitNumber;\n        (session.user as any).commencementDate = token.commencementDate;\n        (session.user as any).ghanaCard = token.ghanaCard;\n        (session.user as any).dob = token.dob;\n      }\n      return session;\n    }\n  },\n\n  // üö™ CUSTOM PAGES\n  pages: {\n    signIn: '/auth/signin',\n    error: '/auth/signin', // Redirect errors back to login\n  },\n\n  // Add useSecureCookies for production\n  useSecureCookies: process.env.NODE_ENV === 'production',\n};"],"names":[],"mappings":"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"}},
    {"offset": {"line": 303, "column": 0}, "map": {"version":3,"sources":["file:///workspaces/nexus-platform/apps/admin/src/lib/auth-helpers.ts"],"sourcesContent":["import { getServerSession } from \"next-auth\";\nimport { authOptions } from \"@/lib/auth\";\nimport { NextResponse } from \"next/server\";\n\n/**\n * üîê AUTHENTICATION & AUTHORIZATION HELPERS\n * Reusable utilities for API route protection and tenant isolation\n */\n\nexport interface AuthenticatedUser {\n    id: string;\n    email: string;\n    name: string | null;\n    role: string;\n    organizationId: string | null;\n}\n\n/**\n * Get authenticated user from session\n * @returns User object or null if not authenticated\n */\nexport async function getAuthenticatedUser(): Promise<AuthenticatedUser | null> {\n    const session = await getServerSession(authOptions);\n\n    if (!session?.user?.email) {\n        return null;\n    }\n\n    return {\n        id: (session.user as any).id || \"\",\n        email: session.user.email,\n        name: session.user.name || null,\n        role: (session.user as any).role || \"WORKER\",\n        organizationId: (session.user as any).organizationId || null,\n    };\n}\n\n/**\n * Require authentication - throws 401 if not authenticated\n * @returns Authenticated user object\n */\nexport async function requireAuth(): Promise<AuthenticatedUser> {\n    const user = await getAuthenticatedUser();\n\n    if (!user) {\n        throw new Error(\"UNAUTHORIZED\");\n    }\n\n    return user;\n}\n\n/**\n * Require specific role(s) - throws 403 if user doesn't have required role\n * @param allowedRoles - Array of allowed roles\n * @returns Authenticated user object\n */\nexport async function requireRole(allowedRoles: string[]): Promise<AuthenticatedUser> {\n    const user = await requireAuth();\n\n    if (!allowedRoles.includes(user.role)) {\n        throw new Error(\"FORBIDDEN\");\n    }\n\n    return user;\n}\n\n/**\n * Get organization ID from authenticated user\n * @param allowSuperAdmin - If true, allows SUPER_ADMIN without organizationId\n * @returns Organization ID\n */\nexport async function getOrganizationId(allowSuperAdmin = false): Promise<string> {\n    const user = await requireAuth();\n\n    // Super admins can bypass organization requirement\n    if (allowSuperAdmin && user.role === \"SUPER_ADMIN\") {\n        return \"\"; // Empty string signals \"all organizations\"\n    }\n\n    if (!user.organizationId) {\n        throw new Error(\"NO_ORGANIZATION\");\n    }\n\n    return user.organizationId;\n}\n\n/**\n * Handle API errors consistently\n * @param error - Error object\n * @returns NextResponse with appropriate status code\n */\nexport function handleApiError(error: any): NextResponse {\n    console.error(\"API Error:\", error);\n\n    if (error.message === \"UNAUTHORIZED\") {\n        return NextResponse.json(\n            { error: \"Unauthorized - Please sign in\" },\n            { status: 401 }\n        );\n    }\n\n    if (error.message === \"FORBIDDEN\") {\n        return NextResponse.json(\n            { error: \"Forbidden - Insufficient permissions\" },\n            { status: 403 }\n        );\n    }\n\n    if (error.message === \"NO_ORGANIZATION\") {\n        return NextResponse.json(\n            { error: \"No organization assigned\" },\n            { status: 400 }\n        );\n    }\n\n    return NextResponse.json(\n        { error: \"Internal server error\" },\n        { status: 500 }\n    );\n}\n"],"names":[],"mappings":";;;;;;;;;;;;AAAA;AACA;AACA;;;;AAmBO,eAAe;IAClB,MAAM,UAAU,MAAM,IAAA,yYAAgB,EAAC,oJAAW;IAElD,IAAI,CAAC,SAAS,MAAM,OAAO;QACvB,OAAO;IACX;IAEA,OAAO;QACH,IAAI,AAAC,QAAQ,IAAI,CAAS,EAAE,IAAI;QAChC,OAAO,QAAQ,IAAI,CAAC,KAAK;QACzB,MAAM,QAAQ,IAAI,CAAC,IAAI,IAAI;QAC3B,MAAM,AAAC,QAAQ,IAAI,CAAS,IAAI,IAAI;QACpC,gBAAgB,AAAC,QAAQ,IAAI,CAAS,cAAc,IAAI;IAC5D;AACJ;AAMO,eAAe;IAClB,MAAM,OAAO,MAAM;IAEnB,IAAI,CAAC,MAAM;QACP,MAAM,IAAI,MAAM;IACpB;IAEA,OAAO;AACX;AAOO,eAAe,YAAY,YAAsB;IACpD,MAAM,OAAO,MAAM;IAEnB,IAAI,CAAC,aAAa,QAAQ,CAAC,KAAK,IAAI,GAAG;QACnC,MAAM,IAAI,MAAM;IACpB;IAEA,OAAO;AACX;AAOO,eAAe,kBAAkB,kBAAkB,KAAK;IAC3D,MAAM,OAAO,MAAM;IAEnB,mDAAmD;IACnD,IAAI,mBAAmB,KAAK,IAAI,KAAK,eAAe;QAChD,OAAO,IAAI,2CAA2C;IAC1D;IAEA,IAAI,CAAC,KAAK,cAAc,EAAE;QACtB,MAAM,IAAI,MAAM;IACpB;IAEA,OAAO,KAAK,cAAc;AAC9B;AAOO,SAAS,eAAe,KAAU;IACrC,QAAQ,KAAK,CAAC,cAAc;IAE5B,IAAI,MAAM,OAAO,KAAK,gBAAgB;QAClC,OAAO,+QAAY,CAAC,IAAI,CACpB;YAAE,OAAO;QAAgC,GACzC;YAAE,QAAQ;QAAI;IAEtB;IAEA,IAAI,MAAM,OAAO,KAAK,aAAa;QAC/B,OAAO,+QAAY,CAAC,IAAI,CACpB;YAAE,OAAO;QAAuC,GAChD;YAAE,QAAQ;QAAI;IAEtB;IAEA,IAAI,MAAM,OAAO,KAAK,mBAAmB;QACrC,OAAO,+QAAY,CAAC,IAAI,CACpB;YAAE,OAAO;QAA2B,GACpC;YAAE,QAAQ;QAAI;IAEtB;IAEA,OAAO,+QAAY,CAAC,IAAI,CACpB;QAAE,OAAO;IAAwB,GACjC;QAAE,QAAQ;IAAI;AAEtB"}},
    {"offset": {"line": 392, "column": 0}, "map": {"version":3,"sources":["file:///workspaces/nexus-platform/apps/admin/src/app/api/operations/pulse-feed/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\nimport { prisma } from \"@/lib/prisma\";\nimport { requireAuth, handleApiError } from \"@/lib/auth-helpers\";\n\nexport async function GET() {\n  try {\n    // üîê Require authentication\n    const user = await requireAuth();\n\n    // üè¢ Build organization filter\n    const orgFilter = user.role === \"SUPER_ADMIN\" && !user.organizationId\n      ? {} // Super admin sees all\n      : { organizationId: user.organizationId };\n\n    const alerts = [];\n    const fourHoursAgo = new Date(Date.now() - 4 * 60 * 60 * 1000);\n\n    // ‚ö°Ô∏è OPTIMIZED: Execute all queries in parallel for speed\n    const [ghosts, lowStock, bigSales, attendances, reports] = await Promise.all([\n      // 1. DETECT \"GHOST\" WORKERS (Logged in but no sales in 4 hours)\n      prisma.user.findMany({\n        where: {\n          ...orgFilter,\n          role: \"WORKER\",\n          status: \"ACTIVE\",\n          attendance: {\n            some: {\n              checkOut: null,\n              checkIn: { lte: fourHoursAgo }\n            }\n          },\n          sales: {\n            none: {\n              createdAt: { gte: fourHoursAgo }\n            }\n          }\n        },\n        select: {\n          id: true,\n          name: true,\n          shop: { select: { name: true } }\n        },\n        take: 5\n      }),\n\n      // 2. DETECT LOW STOCK - ‚ö°Ô∏è OPTIMIZED with select\n      prisma.product.findMany({\n        where: {\n          stockLevel: { lte: 5 },\n          shop: orgFilter\n        },\n        select: {\n          id: true,\n          name: true,\n          stockLevel: true,\n          shop: { select: { name: true } }\n        },\n        take: 3\n      }),\n\n      // 3. DETECT HIGH VALUE SALES - ‚ö°Ô∏è OPTIMIZED with select\n      prisma.sale.findMany({\n        where: {\n          shop: orgFilter,\n          createdAt: { gte: fourHoursAgo } // Only recent sales for performance\n        },\n        select: {\n          id: true,\n          totalAmount: true,\n          createdAt: true,\n          user: { select: { name: true } },\n          shop: { select: { name: true } }\n        },\n        orderBy: { createdAt: 'desc' },\n        take: 5\n      }),\n\n      // 4. DETECT RECENT CHECK-INS - ‚ö°Ô∏è OPTIMIZED with select\n      prisma.attendance.findMany({\n        where: {\n          checkOut: null,\n          checkIn: { gte: fourHoursAgo }, // Only recent check-ins\n          user: orgFilter\n        },\n        select: {\n          id: true,\n          checkIn: true,\n          user: {\n            select: {\n              name: true,\n              shop: { select: { name: true } }\n            }\n          }\n        },\n        orderBy: { checkIn: 'desc' },\n        take: 5\n      }),\n\n      // 5. RECENT FIELD REPORTS - ‚ö°Ô∏è OPTIMIZED with select\n      prisma.dailyReport.findMany({\n        where: {\n          user: orgFilter,\n          createdAt: { gte: fourHoursAgo } // Only recent reports\n        },\n        select: {\n          id: true,\n          createdAt: true,\n          user: {\n            select: {\n              name: true,\n              shop: { select: { name: true } }\n            }\n          }\n        },\n        orderBy: { createdAt: 'desc' },\n        take: 5\n      })\n    ]);\n\n    // Format Ghost Alerts\n    ghosts.forEach(ghost => {\n      alerts.push({\n        id: `ghost-${ghost.id}`,\n        type: \"GHOST_ALERT\",\n        user: ghost.name,\n        shop: ghost.shop?.name || \"Unknown Branch\",\n        message: \"No activity recorded in 4+ hours\",\n        severity: \"HIGH\",\n        timestamp: new Date()\n      });\n    });\n\n    // Format Low Stock Alerts\n    lowStock.forEach(item => {\n      alerts.push({\n        id: `stock-${item.id}`,\n        type: \"STOCK_LOW\",\n        user: \"System\",\n        shop: item.shop.name,\n        message: `${item.name} is running low (${item.stockLevel} left)`,\n        severity: \"MEDIUM\",\n        timestamp: new Date()\n      });\n    });\n\n    // Format Sale Events\n    bigSales.forEach(sale => {\n      alerts.push({\n        id: `sale-${sale.id}`,\n        type: \"SALE_EVENT\",\n        user: sale.user.name,\n        shop: sale.shop.name,\n        message: `Processed a ‚Çµ${sale.totalAmount} transaction`,\n        severity: sale.totalAmount >= 1000 ? \"POSITIVE\" : \"NEUTRAL\",\n        timestamp: sale.createdAt\n      });\n    });\n\n    // Format Attendance Events\n    attendances.forEach(a => {\n      alerts.push({\n        id: `att-${a.id}`,\n        type: \"CHECK_IN\",\n        user: a.user.name,\n        shop: a.user.shop?.name || \"Unknown Branch\",\n        message: `Signed in for duty`,\n        severity: \"NEUTRAL\",\n        timestamp: a.checkIn\n      });\n    });\n\n    // Format Report Events\n    reports.forEach(r => {\n      alerts.push({\n        id: `report-${r.id}`,\n        type: \"FIELD_REPORT\",\n        user: r.user.name,\n        shop: r.user.shop?.name || \"Unknown Branch\",\n        message: `Submitted a field intelligence report`,\n        severity: \"NEUTRAL\",\n        timestamp: r.createdAt\n      });\n    });\n\n    // Final Sort: Most recent first\n    alerts.sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime());\n\n    return NextResponse.json(alerts.slice(0, 20));\n\n  } catch (error: any) {\n    console.error(\"‚ùå PULSE_FEED_ERROR:\", error);\n\n    // Check for auth errors\n    if (error.message === \"UNAUTHORIZED\" || error.message === \"FORBIDDEN\") {\n      return handleApiError(error);\n    }\n\n    // Return empty array instead of crashing\n    return NextResponse.json([]);\n  }\n}"],"names":[],"mappings":"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"}}]
}