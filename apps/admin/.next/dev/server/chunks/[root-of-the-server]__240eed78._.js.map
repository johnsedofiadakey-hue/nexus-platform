{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///workspaces/nexus-platform/apps/admin/src/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\";\n\n/**\n * ðŸ›¡ï¸ SECURE PRISMA CLIENT CONFIGURATION\n * \n * Database: Supabase PostgreSQL (Transaction Pooler)\n * Connection: Uses environment variables for security\n * Mode: Transaction pooling (pgbouncer=true required)\n */\n\nconst globalForPrisma = global as unknown as { prisma: PrismaClient | undefined };\n\nfunction getPrismaClient() {\n  if (globalForPrisma.prisma) {\n    return globalForPrisma.prisma;\n  }\n\n  // Build time: return a dummy client that will fail at runtime if used\n  if (!process.env.DATABASE_URL) {\n    // During build, create a minimal client that won't actually connect\n    const client = new PrismaClient({\n      log: [],\n    });\n    \n    if (process.env.NODE_ENV !== \"production\") {\n      globalForPrisma.prisma = client;\n    }\n    \n    return client;\n  }\n\n  // Runtime: create properly configured client\n  const baseUrl = process.env.DATABASE_URL;\n  const connectionUrl = baseUrl.includes(\"?\")\n    ? `${baseUrl}&pgbouncer=true&connection_limit=1`\n    : `${baseUrl}?pgbouncer=true&connection_limit=1`;\n\n  const client = new PrismaClient({\n    datasources: {\n      db: {\n        url: connectionUrl,\n      },\n    },\n    log: process.env.NODE_ENV === \"development\" ? [\"error\", \"warn\"] : [\"error\"],\n  });\n\n  if (process.env.NODE_ENV !== \"production\") {\n    globalForPrisma.prisma = client;\n  }\n\n  return client;\n}\n\nexport const prisma = getPrismaClient();"],"names":[],"mappings":";;;;AAAA;;AAEA;;;;;;CAMC,GAED,MAAM;AAEN,SAAS;IACP,IAAI,gBAAgB,MAAM,EAAE;QAC1B,OAAO,gBAAgB,MAAM;IAC/B;IAEA,sEAAsE;IACtE,IAAI,CAAC,QAAQ,GAAG,CAAC,YAAY,EAAE;QAC7B,oEAAoE;QACpE,MAAM,SAAS,IAAI,sMAAY,CAAC;YAC9B,KAAK,EAAE;QACT;QAEA,wCAA2C;YACzC,gBAAgB,MAAM,GAAG;QAC3B;QAEA,OAAO;IACT;IAEA,6CAA6C;IAC7C,MAAM,UAAU,QAAQ,GAAG,CAAC,YAAY;IACxC,MAAM,gBAAgB,QAAQ,QAAQ,CAAC,OACnC,GAAG,QAAQ,kCAAkC,CAAC,GAC9C,GAAG,QAAQ,kCAAkC,CAAC;IAElD,MAAM,SAAS,IAAI,sMAAY,CAAC;QAC9B,aAAa;YACX,IAAI;gBACF,KAAK;YACP;QACF;QACA,KAAK,uCAAyC;YAAC;YAAS;SAAO,GAAG;IACpE;IAEA,wCAA2C;QACzC,gBAAgB,MAAM,GAAG;IAC3B;IAEA,OAAO;AACT;AAEO,MAAM,SAAS"}},
    {"offset": {"line": 98, "column": 0}, "map": {"version":3,"sources":["file:///workspaces/nexus-platform/apps/admin/src/app/api/ai/performance-insight/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\nimport { prisma } from \"@/lib/prisma\";\n\nexport async function GET(request: Request) {\n    const { searchParams } = new URL(request.url);\n    const userId = searchParams.get(\"userId\");\n\n    if (!userId) {\n        return NextResponse.json({ error: \"User ID required\" }, { status: 400 });\n    }\n\n    try {\n        const user = await prisma.user.findUnique({\n            where: { id: userId },\n            include: {\n                sales: {\n                    orderBy: { createdAt: 'desc' },\n                    take: 50\n                },\n                attendance: {\n                    orderBy: { checkIn: 'desc' },\n                    take: 20\n                },\n                targets: {\n                    where: { status: 'ACTIVE' },\n                    take: 1\n                },\n                dailyReports: {\n                    orderBy: { createdAt: 'desc' },\n                    take: 5\n                }\n            }\n        });\n\n        if (!user) {\n            return NextResponse.json({ error: \"User not found\" }, { status: 404 });\n        }\n\n        const insights = generateInsights(user);\n        return NextResponse.json(insights);\n\n    } catch (error) {\n        console.error(\"AI_INSIGHT_ERROR:\", error);\n        return NextResponse.json({ error: \"Analysis failed\" }, { status: 500 });\n    }\n}\n\nfunction generateInsights(user: any) {\n    const sales = user.sales || [];\n    const attendance = user.attendance || [];\n    const target = user.targets?.[0];\n    const reports = user.dailyReports || [];\n\n    // 1. Calculate Core Metrics\n    const totalSales = sales.reduce((sum: number, s: any) => sum + s.totalAmount, 0);\n    const totalUnits = sales.length;\n    const avgOrderValue = totalUnits > 0 ? totalSales / totalUnits : 0;\n\n    const targetSalesGap = target ? Math.max(0, target.targetValue - totalSales) : 0;\n    const targetSalesProgress = target ? (totalSales / target.targetValue) * 100 : 0;\n\n    const lateCheckins = attendance.filter((a: any) => {\n        const hour = new Date(a.checkIn).getHours();\n        return hour > 9; // Assuming 9 AM start\n    }).length;\n\n    // 2. Intelligence Heuristics\n    let briefing = \"\";\n    let tone = \"informational\";\n    const recommendations = [];\n\n    if (target) {\n        if (targetSalesProgress >= 90) {\n            briefing = `${user.name} is performing exceptionally well, having achieved ${targetSalesProgress.toFixed(1)}% of the sales target. `;\n            tone = \"positive\";\n            recommendations.push(\"Consider increasing targets for the next period to maintain momentum.\");\n        } else if (targetSalesProgress < 40) {\n            briefing = `${user.name} is significantly behind sales targets (${targetSalesProgress.toFixed(1)}%). `;\n            tone = \"urgent\";\n            recommendations.push(\"Schedule a 1-on-1 review to identify blockers in the sales funnel.\");\n        } else {\n            briefing = `${user.name} is on a steady trajectory with ${targetSalesProgress.toFixed(1)}% target completion. `;\n            tone = \"neutral\";\n        }\n    } else {\n        briefing = `No active targets set for ${user.name}. Currently maintaining a sales volume of ${totalUnits} units. `;\n    }\n\n    // Attendance Insights\n    if (lateCheckins > 2) {\n        briefing += `Consistency issues detected: ${lateCheckins} late check-ins in the last 20 shifts. `;\n        recommendations.push(\"Address morning punctuality to maximize early-hour walk-ins.\");\n    }\n\n    // Sales Quality Insights\n    if (avgOrderValue < 500 && totalUnits > 10) {\n        briefing += `Focus appears to be on high-volume, low-value inventory. `;\n        recommendations.push(\"Coach on cross-selling premium accessories to increase Average Order Value.\");\n    }\n\n    // Report Intel\n    if (reports.length > 0) {\n        const lastReport = reports[0];\n        if (lastReport.marketIntel) {\n            briefing += `Active in field intelligence gathering (latest report submitted ${new Date(lastReport.createdAt).toLocaleDateString()}).`;\n        }\n    }\n\n    return {\n        briefing,\n        tone,\n        metrics: {\n            salesProgress: targetSalesProgress,\n            avgOrderValue,\n            consistencyScore: Math.max(0, 100 - (lateCheckins * 10))\n        },\n        recommendations\n    };\n}\n"],"names":[],"mappings":"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"}}]
}