{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///workspaces/nexus-platform/apps/admin/src/components/maps/GeofenceMap.tsx"],"sourcesContent":["\"use client\";\n\nimport { useEffect, useRef, useState } from 'react';\nimport L from 'leaflet';\nimport 'leaflet/dist/leaflet.css';\nimport { Loader2 } from \"lucide-react\";\n\n// Standard Leaflet Marker Fix\nconst fixIcons = () => {\n  if (typeof window !== 'undefined') {\n    // @ts-ignore\n    delete L.Icon.Default.prototype._getIconUrl;\n    L.Icon.Default.mergeOptions({\n      iconRetinaUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-2x.png',\n      iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png',\n      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',\n    });\n  }\n};\n\ninterface GeofenceMapProps {\n  shopLat: number;\n  shopLng: number;\n  shopRadius: number;\n  userLat?: number | null;\n  userLng?: number | null;\n}\n\nexport default function GeofenceMap({ shopLat, shopLng, shopRadius, userLat, userLng }: GeofenceMapProps) {\n  const mapRef = useRef<HTMLDivElement>(null);\n  const mapInstance = useRef<L.Map | null>(null);\n  const tileLayerRef = useRef<L.TileLayer | null>(null);\n  const [isReady, setIsReady] = useState(false);\n  const [mapStyle, setMapStyle] = useState<'SATELLITE' | 'STREET'>('SATELLITE');\n\n  // LAYERS\n  const SATELLITE_URL = 'https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}';\n  const STREET_URL = 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png'; // Carto Voyager\n\n  useEffect(() => {\n    fixIcons();\n\n    // üõ°Ô∏è STOP: If no div, do nothing. \n    if (!mapRef.current) return;\n\n    // 1. Initialize Map Instance (Only once)\n    if (!mapInstance.current) {\n      const map = L.map(mapRef.current, {\n        zoomControl: false, // Cleaner SaaS look\n        scrollWheelZoom: false\n      }).setView([shopLat, shopLng], 16);\n      mapInstance.current = map;\n\n      // Add Zoom Control back at top right\n      L.control.zoom({ position: 'topright' }).addTo(map);\n\n      // Add Shop Marker (Blue)\n      const shopIcon = new L.Icon({\n        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',\n        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',\n        iconSize: [25, 41],\n        iconAnchor: [12, 41],\n      });\n      L.marker([shopLat, shopLng], { icon: shopIcon }).addTo(map).bindPopup(\"<b>Assigned Hub</b>\");\n\n      // Add Geofence Circle (Emerald/Green)\n      L.circle([shopLat, shopLng], {\n        radius: shopRadius,\n        color: '#10b981',\n        fillColor: '#10b981',\n        fillOpacity: 0.15,\n        weight: 2\n      }).addTo(map);\n\n      setIsReady(true);\n    }\n\n    const map = mapInstance.current;\n\n    // 2. Manage Tile Layer\n    if (tileLayerRef.current) {\n      map.removeLayer(tileLayerRef.current);\n    }\n\n    const newLayer = L.tileLayer(mapStyle === 'SATELLITE' ? SATELLITE_URL : STREET_URL, {\n      attribution: mapStyle === 'SATELLITE' ? '¬© Google' : '&copy; Carto'\n    });\n    newLayer.addTo(map);\n    tileLayerRef.current = newLayer;\n\n    // 5. Update User Marker (Dynamic)\n    // We need to manage this better if position updates, but primarily this effect runs on props change.\n    // Ideally we clear old user markers or use a ref. For now, let's keep it simple as re-renders are rare.\n    // Actually, to avoid duplicates on re-render, we should track the user marker.\n    // But given the scope, and that page likely doesn't spam updates, let's just add it. \n    // Wait, adding it every effect run will duplicate it. Let's fix that.\n\n    // NOTE: In this simplified refactor, I'm just toggling layers. \n    // Use a separate effect for User Marker updates to be cleaner, OR just clear layers.\n    // But since I can't easily refactor EVERYTHING, I'll stick to the previous pattern \n    // but moving Tile logic here allows toggle.\n\n    // Let's add the User Marker logic in a separate block or simple check.\n    // To properly fix duplication, we'd need a userMarkerRef. \n    // I'll add `userMarkerRef` to the component scope in the next edit or assume it's okay for now.\n    // Actually, let's just stick to the requested change: TOGGLE.\n\n    // Re-adding user marker on every style change is bad.\n    // I will separate the concerns: \n    // Effect 1 [mapStyle]: Updates Tile Layer.\n    // Effect 2 [userLat, userLng]: Updates User Marker.\n    // But I have to rewrite the whole useEffect block.\n\n  }, [mapStyle]);\n\n  // SEPARATE EFFECT FOR USER MARKER & INIT\n  useEffect(() => {\n    if (!mapInstance.current || !userLat || !userLng) return;\n    const map = mapInstance.current;\n\n    // Remove existing markers? (Not easily tracked without ref)\n    // Let's just add it for now, assuming full reload on significant change.\n\n    const userIcon = new L.Icon({\n      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',\n      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',\n      iconSize: [25, 41],\n      iconAnchor: [12, 41],\n    });\n    const m = L.marker([userLat, userLng], { icon: userIcon }).addTo(map).bindPopup(\"<b>Agent Location</b>\");\n\n    const bounds = L.latLngBounds([[shopLat, shopLng], [userLat, userLng]]);\n    map.fitBounds(bounds, { padding: [50, 50] });\n\n    return () => { map.removeLayer(m) };\n  }, [userLat, userLng]);\n\n  // CLEANUP\n  useEffect(() => {\n    return () => {\n      if (mapInstance.current) {\n        mapInstance.current.remove();\n        mapInstance.current = null;\n      }\n    };\n  }, []);\n\n  return (\n    <div className=\"w-full h-full relative bg-slate-50 border border-slate-200 rounded-md overflow-hidden group\">\n      <div\n        ref={mapRef}\n        className=\"w-full h-full grayscale-[0.2] contrast-[1.1]\"\n        style={{ zIndex: 1 }}\n      />\n\n      {/* üéÆ CONTROLS */}\n      <div className=\"absolute bottom-4 left-4 z-[500] flex gap-2\">\n        <button\n          onClick={() => setMapStyle('STREET')}\n          className={`px-3 py-1 text-xs font-bold rounded shadow-lg backdrop-blur-md transition-all ${mapStyle === 'STREET' ? 'bg-blue-600 text-white' : 'bg-white/80 text-slate-600 hover:bg-white'}`}\n        >\n          Map\n        </button>\n        <button\n          onClick={() => setMapStyle('SATELLITE')}\n          className={`px-3 py-1 text-xs font-bold rounded shadow-lg backdrop-blur-md transition-all ${mapStyle === 'SATELLITE' ? 'bg-blue-600 text-white' : 'bg-white/80 text-slate-600 hover:bg-white'}`}\n        >\n          Satellite\n        </button>\n      </div>\n\n      {!isReady && (\n        <div className=\"absolute inset-0 flex flex-col items-center justify-center bg-white/80 backdrop-blur-sm z-10\">\n          <Loader2 className=\"w-5 h-5 text-slate-900 animate-spin mb-2\" />\n          <span className=\"text-[10px] font-bold uppercase tracking-widest text-slate-400\">Syncing Satellite...</span>\n        </div>\n      )}\n    </div>\n  );\n}"],"names":[],"mappings":"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"}}]
}