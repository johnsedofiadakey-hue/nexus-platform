generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// --- 1. SUPER ADMIN (SAAS OWNER) ---
// See User Role: 'SUPER_ADMIN'

// --- 2. TENANCY (ORGANIZATIONS) ---
model Organization {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  status      String   @default("ACTIVE") // ACTIVE, SUSPENDED, LOCKED_PAYMENT
  ownerId     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Billing
  plan        String   @default("FREE")
  nextBillingDate DateTime?
  authVersion Int @default(1)

  // üé® BRANDING (White-Label)
  primaryColor   String?   @default("#2563EB") // Blue 600
  secondaryColor String?   @default("#0F172A") // Slate 900
  accentColor    String?   @default("#F59E0B") // Amber 500
  logoUrl        String?   // Base64 or URL

  // Relations
  shops       Shop[]
  users       User[]
  subscriptions Subscription[]
  invoices    Invoice[]
  notifications Notification[]
}

model Subscription {
  id             String       @id @default(cuid())
  tenantId       String
  tenant         Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  planId         String
  plan           Plan         @relation(fields: [planId], references: [id], onDelete: Restrict)
  billingCycle   BillingCycle
  status         SubscriptionStatus
  graceEndsAt    DateTime?
  nextBillingDate DateTime
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([tenantId])
  @@index([status])
  @@index([nextBillingDate])
}

model Plan {
  id                    String   @id @default(cuid())
  name                  String
  pricePerShopMonthly   Float
  annualDiscountPercent Float
  features              String[]
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  subscriptions         Subscription[]

  @@unique([name])
}

model PlatformAdmin {
  id                  String       @id @default(cuid())
  email               String       @unique
  passwordHash        String
  role                PlatformRole @default(OWNER)
  isActive            Boolean      @default(true)
  failedLoginAttempts Int          @default(0)
  lockUntil           DateTime?
  lastLoginAt         DateTime?
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
}

model FeatureFlag {
  id               String   @id @default(cuid())
  key              String   @unique
  enabledGlobally  Boolean  @default(true)
  planRestrictions String[]
  tenantOverrides  Json?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model SystemSetting {
  key       String   @id
  value     String
  updatedAt DateTime @updatedAt
}

model Invoice {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  amount         Float
  status         String       // PAID, PENDING, FAILED
  invoiceDate    DateTime     @default(now())
  paidDate       DateTime?
  pdfUrl         String?
  
  @@index([organizationId])
}

// --- 3. ORGANIZATION ASSETS ---
model Shop {
  id          String    @id @default(cuid())
  
  // üîó TENANCY LINK
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  name        String
  location    String?
  phone       String?
  currency    String    @default("GHS")
  
  // üÜï ADDED: Manager Details
  managerName    String?
  managerContact String?
  
  // üÜï ADDED: Status (Required for seed)
  status      String    @default("ACTIVE") 

  // Geofencing
  latitude    Float?
  longitude   Float?
  radius      Float     @default(50)
  openingTime String?   @default("08:00")
  closingTime String?   @default("22:00")
  
  minutes     Int       @default(0)   // Time spent in zone (minutes)
  
  // Relations
  users       User[]
  products    Product[]
  sales       Sale[]
  expenses    Expense[]
  customers   Customer[]
  categories  InventoryCategory[]
  dailyReports DailyReport[] 

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([organizationId])
}

// --- 1.1 DYNAMIC CATEGORIES ---
model InventoryCategory {
  id            String    @id @default(cuid())
  name          String
  shopId        String
  shop          Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)
  subCategories InventorySubCategory[]
  createdAt     DateTime  @default(now())
  @@index([shopId])
}

model InventorySubCategory {
  id          String    @id @default(cuid())
  name        String
  categoryId  String
  category    InventoryCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  createdAt   DateTime  @default(now())
  @@index([categoryId])
}

// --- 2. USERS (HR) ---
model User {
  id               String    @id @default(cuid())
  
  // üîó TENANCY LINK
  organizationId   String?   // Optional for Super Admin
  organization     Organization? @relation(fields: [organizationId], references: [id])
  
  email            String    @unique
  password         String
  name             String?
  phone            String?
  
  // üÜï ADDED: Job Details (Required for seed/app)
  position         String?   @default("Staff")
  department       String?   @default("General")

  // üÜï ADDED: Personnel Details
  ghanaCard        String?   
  dob              DateTime? 
  image            String?   
  
  // Banking & Statutory
  bankAccountName  String?
  bankName         String?
  bankAccountNumber String?
  ssnitNumber      String?
  commencementDate DateTime?

  role             String    @default("WORKER") // WORKER, MANAGER, ADMIN, SUPER_ADMIN
  status           String    @default("ACTIVE") 
  isInsideZone     Boolean   @default(false)
  bypassGeofence   Boolean   @default(false)
  passwordResetRequired Boolean @default(false)
  
  // üìç GPS TRACKING
  lastLat          Float?
  lastLng          Float?
  lastSeen         DateTime?

  shopId           String?
  shop             Shop?     @relation(fields: [shopId], references: [id])
  
  sales            Sale[]
  expenses         Expense[]
  attendance       Attendance[]
  dailyReports     DailyReport[]
  leaves           LeaveRequest[]
  disciplinary     DisciplinaryRecord[]
  targets          Target[]
  sentMessages     Message[]  @relation("SentMessages")
  receivedMessages Message[]  @relation("ReceivedMessages")
  auditLogs        AuditLog[]
  
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@index([shopId])
  @@index([organizationId])
  @@index([email])
  @@index([role])
  @@index([status])
  @@index([role, status])
  @@index([lastSeen])
}

// --- 3. INVENTORY ---
model Product {
  id           String    @id @default(cuid())
  name         String    @map("productName")
  modelNumber  String?   
  description  String?   
  
  category     String    @default("General")
  subCategory  String?   @default("Unsorted")
  barcode      String?   @unique @map("sku")
  brand        String?   // üÜï ADDED
  
  buyingPrice  Float     @default(0)
  sellingPrice Float     @default(0) @map("priceGHS")
  stockLevel   Int       @default(0) @map("quantity")
  minStock     Int       @default(5)
  
  shopId       String
  shop         Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)
  saleItems    SaleItem[]
  
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([shopId])
  @@index([stockLevel]) // ‚ö°Ô∏è OPTIMIZATION: Speed up Low Stock Alerts
  @@index([category, subCategory]) // ‚ö°Ô∏è OPTIMIZATION: Speed up Filtered Inventory Queries
}

// --- 4. SALES & CUSTOMERS ---
model Sale {
  id            String    @id @default(cuid())
  totalAmount   Float
  amountPaid    Float     @default(0)
  paymentMethod String    @default("CASH")
  status        String    @default("COMPLETED")
  shopId        String
  shop          Shop      @relation(fields: [shopId], references: [id])
  userId        String
  user          User      @relation(fields: [userId], references: [id])
  customerId    String?
  customer      Customer? @relation(fields: [customerId], references: [id])
  items         SaleItem[]
  createdAt     DateTime  @default(now())

  @@index([shopId])
  @@index([userId])
  @@index([customerId])
  @@index([createdAt]) // ‚ö°Ô∏è OPTIMIZATION: Speed up Date Range Filtering
  @@index([userId, createdAt]) // ‚ö°Ô∏è OPTIMIZATION: Speed up User-Specific Sales History
}

model SaleItem {
  id        String  @id @default(cuid())
  quantity  Int
  price     Float
  saleId    String
  sale      Sale    @relation(fields: [saleId], references: [id], onDelete: Cascade)
  productId String
  product   Product @relation(fields: [productId], references: [id])

  @@index([saleId])
  @@index([productId])
}

model Customer {
  id        String   @id @default(cuid())
  name      String
  phone     String?  @unique
  email     String?
  address   String?
  debt      Float    @default(0)
  shopId    String
  shop      Shop     @relation(fields: [shopId], references: [id])
  sales     Sale[]
  createdAt DateTime @default(now())

  @@index([shopId])
}

// --- 5. FINANCE ---
model Expense {
  id          String   @id @default(cuid())
  title       String
  amount      Float
  category    String
  description String?
  date        DateTime @default(now())
  shopId      String
  shop        Shop     @relation(fields: [shopId], references: [id])
  userId      String
  user        User     @relation(fields: [userId], references: [id])

  @@index([shopId])
  @@index([userId])
}

// --- 6. OPERATIONS ---
model Attendance {
  id        String    @id @default(cuid())
  checkIn   DateTime  @default(now())
  checkOut  DateTime?
  status    String    @default("PRESENT")
  note      String?
  userId    String
  user      User      @relation(fields: [userId], references: [id])
  date      DateTime  @default(now())

  @@index([userId])
  @@index([date])    // ‚ö°Ô∏è OPTIMIZATION: Speed up Attendance Queries
  @@index([checkIn]) // ‚ö°Ô∏è OPTIMIZATION: Speed up Ghost Worker Detection
}

model DailyReport {
  id         String   @id @default(cuid())
  date       DateTime @default(now())
  totalSales Float    @default(0)
  totalCash  Float    @default(0)
  totalMomo  Float    @default(0)
  // üìä FUNNEL & INTEL
  walkIns    Int      @default(0)
  inquiries  Int      @default(0)
  buyers     Int      @default(0)
  marketIntel String? // JSON String: [{ brand, model, price }]
  stockGaps   String?

  notes      String?
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  shopId     String?
  shop       Shop?    @relation(fields: [shopId], references: [id])
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([userId])
  @@index([shopId])
  @@index([createdAt])
}

model Target {
  id               String   @id @default(cuid())
  targetQuantity   Int      @default(0)
  targetValue      Float    @default(0)
  achievedQuantity Int      @default(0) // Actual units sold
  achievedValue    Float    @default(0) // Actual revenue
  startDate        DateTime
  endDate          DateTime
  status           String   @default("ACTIVE") // ACTIVE, COMPLETED, EXPIRED, FAILED
  targetType       String   @default("AGENT") // AGENT, ADMIN, TEAM
  
  userId           String
  user             User     @relation(fields: [userId], references: [id])
  
  history          TargetHistory[]
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  @@index([userId])
  @@index([status])
  @@index([targetType])
}

model TargetHistory {
  id               String   @id @default(cuid())
  targetId         String
  target           Target   @relation(fields: [targetId], references: [id], onDelete: Cascade)
  userId           String
  action           String   // CREATED, UPDATED, DELETED, PROGRESS_UPDATE
  previousValue    Json?    // Store previous target values
  newValue         Json?    // Store new target values
  progress         Float    @default(0) // Progress percentage at time of log
  achievedValue    Float    @default(0) // Revenue achieved
  achievedQuantity Int      @default(0) // Units sold
  notes            String?
  createdAt        DateTime @default(now())

  @@index([targetId])
  @@index([userId])
  @@index([createdAt])
}

// Master Activity Log for all system actions
model ActivityLog {
  id          String   @id @default(cuid())
  userId      String
  userName    String
  userRole    String
  action      String   // e.g. "SALE_CREATED", "TARGET_UPDATED", "USER_LOGIN", "REPORT_SUBMITTED"
  entity      String   // e.g. "Sale", "Target", "User", "DailyReport"
  entityId    String?  // The ID of the entity
  description String   // Human-readable description
  metadata    Json?    // Additional context
  ipAddress   String?
  userAgent   String?
  shopId      String?
  shopName    String?
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([entity])
  @@index([createdAt])
  @@index([shopId])
}

// --- 7. HR MODELS ---
model LeaveRequest {
  id        String   @id @default(cuid())
  type      String
  startDate DateTime
  endDate   DateTime
  reason    String?
  status    String   @default("PENDING")
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([userId, status])
  @@index([startDate, endDate])
}

model DisciplinaryRecord {
  id          String   @id @default(cuid())
  type        String
  severity    String
  description String
  actionTaken String?
  date        DateTime @default(now())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  createdAt   DateTime @default(now())
  
  @@index([userId])
}

// --- 8. SYSTEM AUDIT ---
model AuditLog {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  action    String   // e.g. "CREATE_SALE", "UPDATE_PRICE", "DELETE_SHOP"
  entity    String   // e.g. "Product", "Shop"
  entityId  String?  // The ID of the thing being changed
  details   String?  // JSON string of before/after or description
  ipAddress String?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

model Message {
  id         String   @id @default(cuid())
  content    String
  isRead     Boolean  @default(false)
  senderId   String
  sender     User     @relation("SentMessages", fields: [senderId], references: [id])
  receiverId String
  receiver   User     @relation("ReceivedMessages", fields: [receiverId], references: [id])
  createdAt  DateTime @default(now())

  @@index([senderId])
  @@index([receiverId])
  @@index([receiverId, isRead])
  @@index([createdAt])
}

// --- 8. SYSTEM NOTIFICATIONS ---
model Notification {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  type           String       // MESSAGE, LEAVE, ALERT
  title          String
  message        String
  link           String?      // URL to redirect to
  
  isRead         Boolean      @default(false)
  createdAt      DateTime     @default(now())

  @@index([organizationId])
  @@index([isRead])
  @@index([organizationId, isRead])
  @@index([createdAt])
}

enum PlatformRole {
  OWNER
  ENGINEER
  SUPPORT
}

enum BillingCycle {
  MONTHLY
  ANNUAL
}

enum SubscriptionStatus {
  ACTIVE
  GRACE
  LOCKED
  CANCELLED
}