generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider     = "postgresql"
  url          = env("DATABASE_URL")
  directUrl    = env("DIRECT_URL")
  relationMode = "prisma"
}

// --- 1. SUPER ADMIN (SAAS OWNER) ---
// See User Role: 'SUPER_ADMIN'

// --- 2. TENANCY (ORGANIZATIONS) ---
model Organization {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  status      String   @default("ACTIVE") // ACTIVE, SUSPENDED, LOCKED_PAYMENT
  ownerId     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Billing
  plan        String   @default("FREE")
  nextBillingDate DateTime?

  // üé® BRANDING (White-Label)
  primaryColor   String?   @default("#2563EB") // Blue 600
  secondaryColor String?   @default("#0F172A") // Slate 900
  accentColor    String?   @default("#F59E0B") // Amber 500
  logoUrl        String?   // Base64 or URL

  // Relations
  shops       Shop[]
  users       User[]
  subscriptions Subscription[]
  invoices    Invoice[]
  notifications Notification[]
}

model Subscription {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  planType       String       // MONTHLY, ANNUAL
  amount         Float
  currency       String       @default("GHS")
  status         String       // ACTIVE, CANCELLED, PAST_DUE
  startDate      DateTime     @default(now())
  endDate        DateTime
  paystackSubCode String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([organizationId])
}

model Invoice {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  amount         Float
  status         String       // PAID, PENDING, FAILED
  invoiceDate    DateTime     @default(now())
  paidDate       DateTime?
  pdfUrl         String?
  
  @@index([organizationId])
}

// --- 3. ORGANIZATION ASSETS ---
model Shop {
  id          String    @id @default(cuid())
  
  // üîó TENANCY LINK
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  name        String
  location    String?
  phone       String?
  currency    String    @default("GHS")
  
  // üÜï ADDED: Manager Details
  managerName    String?
  managerContact String?
  
  // üÜï ADDED: Status (Required for seed)
  status      String    @default("ACTIVE") 

  // Geofencing
  latitude    Float?
  longitude   Float?
  radius      Float     @default(50)
  openingTime String?   @default("08:00")
  closingTime String?   @default("22:00")
  
  minutes     Int       @default(0)   // Time spent in zone (minutes)
  
  // Relations
  users       User[]
  products    Product[]
  sales       Sale[]
  expenses    Expense[]
  customers   Customer[]
  categories  InventoryCategory[] 

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([organizationId])
}

// --- 1.1 DYNAMIC CATEGORIES ---
model InventoryCategory {
  id            String    @id @default(cuid())
  name          String
  shopId        String
  shop          Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)
  subCategories InventorySubCategory[]
  createdAt     DateTime  @default(now())
  @@index([shopId])
}

model InventorySubCategory {
  id          String    @id @default(cuid())
  name        String
  categoryId  String
  category    InventoryCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  createdAt   DateTime  @default(now())
  @@index([categoryId])
}

// --- 2. USERS (HR) ---
model User {
  id               String    @id @default(cuid())
  
  // üîó TENANCY LINK
  organizationId   String?   // Optional for Super Admin
  organization     Organization? @relation(fields: [organizationId], references: [id])
  
  email            String    @unique
  password         String
  name             String?
  phone            String?
  
  // üÜï ADDED: Job Details (Required for seed/app)
  position         String?   @default("Staff")
  department       String?   @default("General")

  // üÜï ADDED: Personnel Details
  ghanaCard        String?   
  dob              DateTime? 
  image            String?   
  
  // Banking & Statutory
  bankAccountName  String?
  bankName         String?
  bankAccountNumber String?
  ssnitNumber      String?
  commencementDate DateTime?

  role             String    @default("WORKER") // WORKER, MANAGER, ADMIN, SUPER_ADMIN
  status           String    @default("ACTIVE") 
  isInsideZone     Boolean   @default(false)
  bypassGeofence   Boolean   @default(false)
  
  // üìç GPS TRACKING
  lastLat          Float?
  lastLng          Float?
  lastSeen         DateTime?

  shopId           String?
  shop             Shop?     @relation(fields: [shopId], references: [id])
  
  sales            Sale[]
  expenses         Expense[]
  attendance       Attendance[]
  dailyReports     DailyReport[]
  leaves           LeaveRequest[]
  disciplinary     DisciplinaryRecord[]
  targets          Target[]
  sentMessages     Message[]  @relation("SentMessages")
  receivedMessages Message[]  @relation("ReceivedMessages")
  auditLogs        AuditLog[]
  
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@index([shopId])
  @@index([organizationId])
}

// --- 3. INVENTORY ---
model Product {
  id           String    @id @default(cuid())
  name         String    @map("productName")
  modelNumber  String?   
  description  String?   
  
  category     String    @default("General")
  subCategory  String?   @default("Unsorted")
  barcode      String?   @unique @map("sku")
  
  buyingPrice  Float     @default(0)
  sellingPrice Float     @default(0) @map("priceGHS")
  stockLevel   Int       @default(0) @map("quantity")
  minStock     Int       @default(5)
  
  shopId       String
  shop         Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)
  saleItems    SaleItem[]
  
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([shopId])
  @@index([stockLevel]) // ‚ö°Ô∏è OPTIMIZATION: Speed up Low Stock Alerts
}

// --- 4. SALES & CUSTOMERS ---
model Sale {
  id            String    @id @default(cuid())
  totalAmount   Float
  amountPaid    Float     @default(0)
  paymentMethod String    @default("CASH")
  status        String    @default("COMPLETED")
  shopId        String
  shop          Shop      @relation(fields: [shopId], references: [id])
  userId        String
  user          User      @relation(fields: [userId], references: [id])
  customerId    String?
  customer      Customer? @relation(fields: [customerId], references: [id])
  items         SaleItem[]
  createdAt     DateTime  @default(now())

  @@index([shopId])
  @@index([userId])
  @@index([customerId])
  @@index([createdAt]) // ‚ö°Ô∏è OPTIMIZATION: Speed up Date Range Filtering
}

model SaleItem {
  id        String  @id @default(cuid())
  quantity  Int
  price     Float
  saleId    String
  sale      Sale    @relation(fields: [saleId], references: [id], onDelete: Cascade)
  productId String
  product   Product @relation(fields: [productId], references: [id])

  @@index([saleId])
  @@index([productId])
}

model Customer {
  id        String   @id @default(cuid())
  name      String
  phone     String?  @unique
  email     String?
  address   String?
  debt      Float    @default(0)
  shopId    String
  shop      Shop     @relation(fields: [shopId], references: [id])
  sales     Sale[]
  createdAt DateTime @default(now())

  @@index([shopId])
}

// --- 5. FINANCE ---
model Expense {
  id          String   @id @default(cuid())
  title       String
  amount      Float
  category    String
  description String?
  date        DateTime @default(now())
  shopId      String
  shop        Shop     @relation(fields: [shopId], references: [id])
  userId      String
  user        User     @relation(fields: [userId], references: [id])

  @@index([shopId])
  @@index([userId])
}

// --- 6. OPERATIONS ---
model Attendance {
  id        String    @id @default(cuid())
  checkIn   DateTime  @default(now())
  checkOut  DateTime?
  status    String    @default("PRESENT")
  note      String?
  userId    String
  user      User      @relation(fields: [userId], references: [id])
  date      DateTime  @default(now())

  @@index([userId])
  @@index([date])    // ‚ö°Ô∏è OPTIMIZATION: Speed up Attendance Queries
  @@index([checkIn]) // ‚ö°Ô∏è OPTIMIZATION: Speed up Ghost Worker Detection
}

model DailyReport {
  id         String   @id @default(cuid())
  date       DateTime @default(now())
  totalSales Float    @default(0)
  totalCash  Float    @default(0)
  totalMomo  Float    @default(0)
  // üìä FUNNEL & INTEL
  walkIns    Int      @default(0)
  inquiries  Int      @default(0)
  buyers     Int      @default(0)
  marketIntel String? // JSON String: [{ brand, model, price }]
  stockGaps   String?

  notes      String?
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([userId])
}

model Target {
  id             String   @id @default(cuid())
  targetQuantity Int      @default(0)
  targetValue    Float    @default(0)
  startDate      DateTime
  endDate        DateTime
  status         String   @default("ACTIVE") // ACTIVE, COMPLETED, EXPIRED
  
  userId         String
  user           User     @relation(fields: [userId], references: [id])
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  @@index([userId])
}

// --- 7. HR MODELS ---
model LeaveRequest {
  id        String   @id @default(cuid())
  type      String
  startDate DateTime
  endDate   DateTime
  reason    String?
  status    String   @default("PENDING")
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model DisciplinaryRecord {
  id          String   @id @default(cuid())
  type        String
  severity    String
  description String
  actionTaken String?
  date        DateTime @default(now())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  createdAt   DateTime @default(now())
  
  @@index([userId])
}

// --- 8. SYSTEM AUDIT ---
model AuditLog {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  action    String   // e.g. "CREATE_SALE", "UPDATE_PRICE", "DELETE_SHOP"
  entity    String   // e.g. "Product", "Shop"
  entityId  String?  // The ID of the thing being changed
  details   String?  // JSON string of before/after or description
  ipAddress String?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

model Message {
  id         String   @id @default(cuid())
  content    String
  isRead     Boolean  @default(false)
  senderId   String
  sender     User     @relation("SentMessages", fields: [senderId], references: [id])
  receiverId String
  receiver   User     @relation("ReceivedMessages", fields: [receiverId], references: [id])
  createdAt  DateTime @default(now())

  @@index([senderId])
  @@index([receiverId])
}

// --- 8. SYSTEM NOTIFICATIONS ---
model Notification {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  type           String       // MESSAGE, LEAVE, ALERT
  title          String
  message        String
  link           String?      // URL to redirect to
  
  isRead         Boolean      @default(false)
  createdAt      DateTime     @default(now())

  @@index([organizationId])
  @@index([isRead])
}