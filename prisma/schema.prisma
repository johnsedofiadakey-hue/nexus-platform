// ----------------------------------------------------------------
// NEXUS GLOBAL SCHEMA - v25.6 (POSTGRESQL / NEON EDITION)
// ----------------------------------------------------------------

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL") // Required for Neon migrations
}

// --- 1. IDENTITY & HR ---
model User {
  id              String   @id @default(uuid())
  name            String
  email           String   @unique
  password        String
  role            Role     @default(SALES_REP)
  phone           String?
  ghanaCard       String?
  status          Status   @default(ACTIVE)
  image           String?  // Exposes avatar support
  
  // Operational Links
  shopId          String?   
  shop            Shop?    @relation(fields: [shopId], references: [id])
  
  // HR Data
  attendance      Attendance[]
  leaves          LeaveRequest[]
  disciplinary    DisciplinaryRecord[] @relation("ReceivedCitations")
  issuedCitations DisciplinaryRecord[] @relation("IssuedCitations")

  // Sales Data
  sales           Sale[]
  dailyReports    DailyReport[]
  
  // Chat
  sentMessages     Message[] @relation("SentMessages")
  receivedMessages Message[] @relation("ReceivedMessages")

  // GPS Tracking & Sentinel Data
  lastLat         Float?
  lastLng         Float?
  lastSync        DateTime?
  isInsideZone    Boolean   @default(false)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

enum Role {
  SUPER_USER
  ADMIN
  HR_MANAGER
  SALES_REP
}

enum Status {
  ACTIVE
  SUSPENDED
  ON_LEAVE
  TERMINATED
}

// --- 2. RETAIL NETWORK (SHOPS) ---
model Shop {
  id            String    @id @default(uuid())
  name          String
  location      String    
  latitude      Float
  longitude     Float
  radius        Int       @default(150) 
  
  managerName   String?
  managerPhone  String?
  openingTime   String?   @default("08:00 AM")

  // Relations
  staff         User[]
  inventory     Product[]
  sales         Sale[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// --- 3. SUPPLY CHAIN (INVENTORY) ---
model Product {
  id            String    @id @default(uuid())
  productName   String
  sku           String    @unique
  
  // Financials
  priceGHS      Float
  quantity      Int
  minStock      Int       @default(5)
  
  // Categorization (Formulation Tracking)
  formulation   String?   @default("FINISHED_GOOD") 
  category      String?   
  subCat        String?   
  
  // Linking
  shopId        String?   
  shop          Shop?     @relation(fields: [shopId], references: [id])
  
  subCategoryId String?   
  subCategory   SubCategory? @relation(fields: [subCategoryId], references: [id])

  saleItems     SaleItem[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Category {
  id            String        @id @default(uuid())
  name          String        @unique
  subCategories SubCategory[]
}

model SubCategory {
  id            String    @id @default(uuid())
  name          String
  categoryId    String    
  category      Category  @relation(fields: [categoryId], references: [id])
  products      Product[]
}

// --- 4. SALES ENGINE ---
model Sale {
  id            String     @id @default(uuid())
  totalAmount   Float
  
  // Source Tracking (Gen Z Analytics)
  source        String     @default("POS") // MOBILE or POS
  paymentMethod String     @default("CASH")
  
  // Location Data (Sales Verification)
  latitude      Float?
  longitude     Float?
  
  // Links
  userId        String     
  user          User       @relation(fields: [userId], references: [id])
  
  shopId        String?    
  shop          Shop?      @relation(fields: [shopId], references: [id])
  
  items         SaleItem[]
  
  createdAt     DateTime   @default(now())
}

model SaleItem {
  id            String   @id @default(uuid())
  saleId        String   
  sale          Sale     @relation(fields: [saleId], references: [id])
  
  productId     String   
  product       Product  @relation(fields: [productId], references: [id])
  
  quantity      Int
  priceAtSale   Float
}

model DailyReport {
  id            String   @id @default(uuid())
  userId        String   
  user          User     @relation(fields: [userId], references: [id])
  
  walkIns       Int      @default(0)
  buyers        Int      @default(0) // Renamed from inquiries to match Pulse logic
  marketIntel   String?  
  stockGaps     String?  // Specifically for field intelligence
  
  createdAt     DateTime @default(now())
}

// --- 5. HR & COMPLIANCE ---
model Attendance {
  id            String    @id @default(uuid())
  userId        String    
  user          User      @relation(fields: [userId], references: [id])
  
  date          DateTime
  clockInTime   DateTime?
  clockOutTime  DateTime?
  
  gpsLat        Float?
  gpsLng        Float?
}

model LeaveRequest {
  id            String   @id @default(uuid())
  userId        String   
  user          User     @relation(fields: [userId], references: [id])
  
  type          String   
  startDate     DateTime
  endDate       DateTime
  reason        String
  status        String   @default("PENDING") 
  
  createdAt     DateTime @default(now())
}

model DisciplinaryRecord {
  id            String   @id @default(uuid())
  userId        String   
  user          User     @relation("ReceivedCitations", fields: [userId], references: [id])
  
  issuerId      String   
  issuer        User     @relation("IssuedCitations", fields: [issuerId], references: [id])
  
  type          String   
  severity      String   
  description   String
  actionTaken   String?  
  
  createdAt     DateTime @default(now())
}

model Message {
  id            String   @id @default(uuid())
  content       String
  
  senderId      String   
  sender        User     @relation("SentMessages", fields: [senderId], references: [id])
  
  receiverId    String   
  receiver      User     @relation("ReceivedMessages", fields: [receiverId], references: [id])
  
  read          Boolean  @default(false)
  createdAt     DateTime @default(now())
}